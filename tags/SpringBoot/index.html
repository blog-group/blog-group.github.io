<!DOCTYPE html>
<html  lang="zh">
<head>
    <meta charset="utf-8" />

<meta name="generator" content="Hexo 3.9.0" />

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />

<title>标签: SpringBoot - 程序员恒宇少年 | SpringBoot | SpringCloud | Java - 个人博客</title>


    <meta name="description" content="记录程序员恒宇少年 - 于起宇工作日常遇到的问题，针对技术点提供文章导读，源码分析，主要提供Java、Spring、SpringBoot、SpringCloud等相关知识，提供有关恒宇少年,ApiBoot,apiboot,springboot,spring,SpringBoot,springcloud,SpringCloud,微服务,框架使用,技术文章技术文章">
<meta name="keywords" content="恒宇少年,于起宇,ApiBoot,SpringBoot,SpringCloud,微服务">
<meta property="og:type" content="website">
<meta property="og:title" content="程序员恒宇少年 | SpringBoot | SpringCloud | Java - 个人博客">
<meta property="og:url" content="https://blog.minbox.org/tags/SpringBoot/index.html">
<meta property="og:site_name" content="程序员恒宇少年 | SpringBoot | SpringCloud | Java - 个人博客">
<meta property="og:description" content="记录程序员恒宇少年 - 于起宇工作日常遇到的问题，针对技术点提供文章导读，源码分析，主要提供Java、Spring、SpringBoot、SpringCloud等相关知识，提供有关恒宇少年,ApiBoot,apiboot,springboot,spring,SpringBoot,springcloud,SpringCloud,微服务,框架使用,技术文章技术文章">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://blog.minbox.org/images/og_image.png">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="程序员恒宇少年 | SpringBoot | SpringCloud | Java - 个人博客">
<meta name="twitter:description" content="记录程序员恒宇少年 - 于起宇工作日常遇到的问题，针对技术点提供文章导读，源码分析，主要提供Java、Spring、SpringBoot、SpringCloud等相关知识，提供有关恒宇少年,ApiBoot,apiboot,springboot,spring,SpringBoot,springcloud,SpringCloud,微服务,框架使用,技术文章技术文章">
<meta name="twitter:image" content="https://blog.minbox.org/images/og_image.png">







<link rel="icon" href="/images/favicon.jpg">


<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.7.2/css/bulma.css">
<link rel="stylesheet" href="/css/font-awesome-5.4.1-all.min.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ubuntu:400,600|Source+Code+Pro">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/ocean.css">


    
    
    
    <style>body>.footer,body>.navbar,body>.section{opacity:0}</style>
    

    
    
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css">
    

    
    

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.css">


    
    
    
    

<link rel="stylesheet" href="/css/back-to-top.css">


    
    
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-127746557-1"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-127746557-1');
</script>


    
    
    
    

    
    
<link rel="stylesheet" href="/css/progressbar.css">
<script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script>

    
    
    
        <script async="" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    

    


<link rel="stylesheet" href="/css/style.css">
</head>
<body class="is-2-column">
    <nav class="navbar navbar-main">
  <div class="container">
    <div class="navbar-brand is-flex-center">
      <a class="navbar-item navbar-logo" href="/">
        <div class="logo"></div>
        <span class="site_title">恒宇少年 - 于起宇</span>
      </a>
    </div>
    <div class="navbar-menu">
      
      <div class="navbar-start nav-link">
        
        <a class="navbar-item"
          href="/interview-strategy.html" target="_blank">面试攻略</a>
        
        <a class="navbar-item"
          href="/welfare/" target="_blank">签到送书</a>
        
        <a class="navbar-item"
          href="/geektime/" target="_blank">推荐课程</a>
        
        <a class="navbar-item"
          href="/opensource/" target="_blank">我的开源</a>
        
        <a class="navbar-item"
          href="/openbooks/" target="_blank">免费书籍</a>
        
        <a class="navbar-item"
          href="/years/2019.html" target="_blank">我的2019</a>
        
        <a class="navbar-item"
          href="/archives/" target="_blank">归档</a>
        
      </div>
      
      <div class="navbar-end">
        
        
        
        <a class="navbar-item search" title="搜索" href="javascript:;">
          <i class="fas fa-search"></i>
        </a>
        
      </div>
    </div>
  </div>
</nav>
    
    <section class="section">
        <div class="container">
            <div class="columns">
                <div class="column is-8-tablet is-9-desktop is-9-widescreen has-order-2 column-main"><div class="card">
    <div class="card-content">
        <nav class="breadcrumb" aria-label="breadcrumbs">
        <ul>
            <li><a href="/tags">标签</a></li>
            <li class="is-active"><a href="#" aria-current="page">SpringBoot</a></li>
        </ul>
        </nav>
    </div>
</div>
<!--文章列表-->

    
<div id="container">
  
  <div class="card" style="margin-bottom: 10px">
    
    <div class="card-content article ">
      <!--文章标题-->
      
      <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
        
        <a class="has-link-black-ter" href="/know-openj9-jvm.html">微服务中使用 OpenJ9 JVM 内存占用降60%(相对HotSpot)</a>
        
      </h1>
      <!--完全自定义页面显示的访问次数-->
      
      
      <div class="level article-meta is-mobile is-overflow-x-auto" style="font-size: 15px">
        <div class="level-left">
          <!--文章类型-->
          
          
          <span
            style="float: left;padding: 1px 2px 1px 2px;margin-right: 5px;background-color: #a9800a;color: white;text-align: center;border-radius:0.25em;font-size: 14px">
            转载</span>
          
          
          
          &nbsp;&nbsp;&nbsp;&nbsp;
          <!--发布时间-->
          <img src="/images/date_time.png" style="width: 25px;" title="发布时间"/>
          &nbsp;
          <span class="article-meta-element">2022-08-12</span>
          &nbsp;&nbsp;&nbsp;&nbsp;
          <!--作者-->
          <img src="/images/author.svg" style="width: 23px" title="文章作者"/>

          <span class="article-meta-element">陈一乐</span>
          &nbsp;&nbsp;&nbsp;&nbsp;
          <!--目录列表-->
          
          <img src="/images/categories.svg" style="width: 20px;" title="文章所属目录列表"/>
          &nbsp;
          <div class="level-item article-meta-element">
            <!--读取config.yml文件内的目录配置-->
            
            
              
                
              
                
                  <!--跳转文章目录地址-->
                  <a class="category-link" href="/spring-cloud-all-articles.html">SpringCloud</a>&nbsp;
                
              
                
              
                
              
            
              
                
                  <!--跳转文章目录地址-->
                  <a class="category-link" href="/spring-boot-all-articles.html">SpringBoot</a>&nbsp;
                
              
                
              
                
              
                
              
            
          </div>
          
          <!--不蒜子统计阅读量-->
          <!---->
        </div>
      </div>
      
      
      <!--推荐阅读 - 新闻-->
      
      <!--文章内容-->
      <div class="content">
        <p>随着微服务的普及，许多企业踏上微服务之旅。</p>
<p>微服务化后，应用数量可能高一个数量级。一般企业，以前三五个应用能支撑业务，微服务化之后应用数量可能多达几十个。<br>每个微服务往往独立部署，内存的消耗自然也高居不下，以前两台8核16G机器指不定就能跑起来，现两台16核64G还不一定够用，同时由于多套环境的存在加上容器编排工具(如K8s)所需的资源，硬件资源的投入自然是成倍增加。</p>
<p>在 Web 应用开发中，为了降低内存消耗，你是否尝试过：</p>
<ul>
<li><strong>去除不必要的组件，减少代码体积</strong></li>
<li><strong>更换 Web 容器，如将 Tomcat 更换为Undertow</strong></li>
<li><strong>优化Docker基础镜像，减少镜像体积</strong></li>
</ul>
<p>这些效果往往不是很理想。本篇介绍 OpenJ9 JVM，通过将 HotSpot 更换为 OpenJ9，内存占用能降低至少 60%，而启动时间也能快 40% 以上，效果立竿见影。</p>
<h2 id="OpenJ9-简介"><a href="#OpenJ9-简介" class="headerlink" title="OpenJ9 简介"></a>OpenJ9 简介</h2><p>OpenJ9 的前身是IBM的 J9 Java 虚拟机，主要服务于IBM企业级软件产品，是一款高性能的JVM。</p>
<p>2017年9月，IBM 将 J9 JVM 捐献给 Eclipse 基金会，并更名 Eclipse OpenJ9，开启开源之旅。</p>
<p>OpenJ9 擅长于内存管理，同时针对容器化做了很多工作，按官方说法是： more container-aware 。</p>
<p>下面摘自 OpenJ9 的 <a href="https://www.eclipse.org/openj9/oj9_whatsnew.html" target="_blank" rel="noopener">Release History</a>，选择了部分内容，可快速一览：</p>
<ul>
<li><p>2017.11 支持使用 OpenJDK8 构建 OpenJ9</p>
</li>
<li><p>2018.3 发布 0.8.0：OpenJ9 开始支持各平台(Mac、Linux、Windows等) 的 OpenJDK 8，宣布在JDK8中，比HotSpot 42% faster startup and a footprint at least 60% smaller</p>
</li>
<li><p>2018.8 发布 0.9.0：支持 OpenJDK 10；对Docker容器支持更友好；在运行一些Eclipse性能测试时，比HotSpot JVM快 43%，少用42%的内存.</p>
</li>
<li><p>2018.10 发布 0.10.0：支持 OpenJDK 11，开始适配 HotSpot JVM的一些参数配置</p>
</li>
<li><p>2018.10 发布 0.11.0：改善AOT性能、针对运行在容器中的应用内存优化、 “pause-less” GC mode for response-time sensitive, large heap applications</p>
</li>
<li><p>2019.2 发布 0.12.1 ：提示RSA算法加密性能；性能进一步提升</p>
</li>
<li><p>2019.3 发布 0.13.0：支持OpenJDK 12; 支持jps命令；支持将Java dump 文件写入STDOUT/STDERR</p>
</li>
</ul>
<h2 id="官方性能报告"><a href="#官方性能报告" class="headerlink" title="官方性能报告"></a>官方性能报告</h2><p>下面是 OpenJ9官方的基准测试结果(完整报告)，包含启动时间、响应时间、吞吐量等指标。</p>
<p><strong>66% smaller footprint after startup</strong></p>
<p>由于减少内存占用的重要性，OpenJ9 对云负载(cloud wordloads)做了深度优化，在应用启动后，占用内存比HotSpot 约少 66%。</p>
<p><strong>66% smaller footprint after startup</strong></p>
<p>由于减少内存占用的重要性，OpenJ9 对云负载(cloud wordloads)做了深度优化，在应用启动后，占用内存比HotSpot 约少 66%。</p>
<p><a href="https://blog-1256695615.cos.ap-shanghai.myqcloud.com/2019/07/20/2.png" target="_blank" rel="noopener"><img src="https://blog-1256695615.cos.ap-shanghai.myqcloud.com/2019/07/20/2.png" alt="img"></a></p>
<p><strong>63% smaller footprint during ramp up</strong></p>
<p>应用负载增加时，内存都会骤增。但状态稳定后，使用 OpenJ9 的OpenJDK 8 比使用 HotSpot 的 OpenJDK 8 <strong>减少了约 63% 的物理内存</strong>。</p>
<p><a href="https://blog-1256695615.cos.ap-shanghai.myqcloud.com/2019/07/20/3.png" target="_blank" rel="noopener"><img src="https://blog-1256695615.cos.ap-shanghai.myqcloud.com/2019/07/20/3.png" alt="img"></a></p>
<p><strong>42% faster startup time</strong></p>
<p><strong>Shared classes</strong> 和 <strong>Ahead-of-Time(AOT)</strong> 技术的应用显著减少了应用启动时间。通过使用 <strong>-Xquickstart</strong> 参数(启用AOT)，<strong>启动时间可以减少高达42%</strong>。</p>
<p><a href="https://blog-1256695615.cos.ap-shanghai.myqcloud.com/2019/07/20/4.png" target="_blank" rel="noopener"><img src="https://blog-1256695615.cos.ap-shanghai.myqcloud.com/2019/07/20/4.png" alt="img"></a></p>
<p><strong>Comparable throughput</strong></p>
<p>在做吞吐量对比时，二者峰值吞吐量差不多，但使用OpenJ9 的 OpenJDK 8 大约快1分钟达到峰值。</p>
<p><a href="https://blog-1256695615.cos.ap-shanghai.myqcloud.com/2019/07/20/5.png" target="_blank" rel="noopener"><img src="https://blog-1256695615.cos.ap-shanghai.myqcloud.com/2019/07/20/5.png" alt="img"></a></p>
<p><strong>Faster ramp-up time in the cloud</strong></p>
<p>在云环境下，虚拟化技术被广泛使用，一台大的机器经常被切割成若干小的虚拟机，这些虚拟机往往做了资源限制。OpenJ9 在单核CPU上用了8.5分钟达到峰值吞吐量，而 HotSpot用了30分钟。对于在资源受限的环境下(如云环境)跑 short-lived VMs，能够更快的完成更多工作就显得更为重要。</p>
<p>资源受限的一大副作用就是 <strong>Java应用花费更长的启动时间(受JIT影响)</strong>。</p>
<blockquote>
<p>笔者注：内存限制时，应用甚至会无法启动，导致不断重启。</p>
</blockquote>
<p><a href="https://blog-1256695615.cos.ap-shanghai.myqcloud.com/2019/07/20/6.png" target="_blank" rel="noopener"><img src="https://blog-1256695615.cos.ap-shanghai.myqcloud.com/2019/07/20/6.png" alt="img"></a></p>
<h2 id="性能测试"><a href="#性能测试" class="headerlink" title="性能测试"></a>性能测试</h2><p>创建一个 Spring Boot Web 应用并打成jar包，分别使用 HotSpot、OpenJ9 虚拟机的 Open JDK8 结合Docker来做测试。</p>
<p>基于OpenJ9的Dockerfile</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">FROM adoptopenjdk/openjdk8-openj9:alpine-slim</span><br><span class="line">COPY target/app.jar /app.jar</span><br><span class="line">ENTRYPOINT java $JAVA_OPTS -Xshareclasses -Xquickstart -jar /app.jar</span><br></pre></td></tr></table></figure>

<p>基于HotSpot的Dockerfile</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">FROM openjdk:8u181-jre-slim-stretch</span><br><span class="line">COPY target/app.jar /app.jar</span><br><span class="line">ENTRYPOINT java $JAVA_OPTS -jar /app.jar</span><br></pre></td></tr></table></figure>

<p>启动容器后，<code>docker stats openj9 hotspot</code> 查看容器资源使用情况如下：</p>
<p><a href="https://blog-1256695615.cos.ap-shanghai.myqcloud.com/2019/07/20/1.png" target="_blank" rel="noopener"><img src="https://blog-1256695615.cos.ap-shanghai.myqcloud.com/2019/07/20/1.png" alt="img"></a></p>
<p>OpenJ9 是 50.89M；HotSpot 是235.7M，差异非常大。</p>
<p>下面是我们测试环境中的一个普通应用(使用Docker运行)的测试结果。</p>
<p>基于 Open JDK8 (HotSpot) 时内存消耗稳定在 <strong>1G左右</strong>。</p>
<p><a href="https://blog-1256695615.cos.ap-shanghai.myqcloud.com/2019/07/21/2.png" target="_blank" rel="noopener"><img src="https://blog-1256695615.cos.ap-shanghai.myqcloud.com/2019/07/21/2.png" alt="img"></a></p>
<p>基于 OpenJDK8(OpenJ9)时内存消耗稳定在 <strong>300M左右</strong>。</p>
<p><a href="https://blog-1256695615.cos.ap-shanghai.myqcloud.com/2019/07/21/3.png" target="_blank" rel="noopener"><img src="https://blog-1256695615.cos.ap-shanghai.myqcloud.com/2019/07/21/3.png" alt="img"></a></p>
<h2 id="该怎么切换到-OpenJ9-？"><a href="#该怎么切换到-OpenJ9-？" class="headerlink" title="该怎么切换到 OpenJ9 ？"></a>该怎么切换到 OpenJ9 ？</h2><p>如果使用Docker，直接更换基础镜像即可，容器场景下更能发挥 OpenJ9 的作用。</p>
<p>如果JDK直接安装在服务器上，可以直接在 <a href="https://adoptopenjdk.net/releases.html?variant=openjdk8&jvmVariant=openj9" target="_blank" rel="noopener">AdoptOpenJDK</a> 上下载相应的介质。</p>
<p>对于 <a href="https://www.eclipse.org/openj9/docs/cmdline_migration/" target="_blank" rel="noopener">JVM Options</a>，可以参考做一些调整。</p>
<h2 id="对开发人员的影响有哪些？"><a href="#对开发人员的影响有哪些？" class="headerlink" title="对开发人员的影响有哪些？"></a>对开发人员的影响有哪些？</h2><p>大家一般接触的都是HotSpot VM，且对于其理论、JVM参数、命令行工具甚至性能调优等相对比较熟悉，这块资料也比较丰富。</p>
<p>OpenJ9 以前更多的是支持IBM企业级的商业产品，大家了解相对较少，连日用命令行工具暂时都只提供了jps、jstack，不过可以使用像阿里 <a href="https://alibaba.github.io/arthas/" target="_blank" rel="noopener">arthas</a> 这类Java应用诊断工具，效果也是一样的。</p>
<p>对于小企业来说，JVM一般不是瓶颈，而更换JVM所带来的IT成本投入减少确是实实在在的，尤其是对于初创团队，自然是能省则省。</p>

        
        <!--原创-->
        
        <!--转载标注-->
        
        
      </div>
      <!--文章标签-->
      
      
      
    </div>
  </div>

  
  

  
  <!--评论-->
  
  
</div>

<script src="/js/readmore.js" type="text/javascript"></script>
<script>
  const btw = new BTWPlugin();
  btw.init({
    id: 'container',
    blogId: '10034-1569731208928-426',
    name: '恒宇少年',
    qrcode: 'https://blog.yuqiyu.com/images/mp.jpg',
    keyword: 'free',
  });
</script>

<!--<script src="/js/layui.js"></script>
<script>
  layui.use(['layer'], function () {
    var layer = layui.layer;
    var isShowOnce = localStorage.getItem('isShowHistory');
    if (!isShowOnce) {
      localStorage.setItem('isShowHistory',true);
      layer.open({
          type: 1
          ,title: false //不显示标题栏
          ,closeBtn: false
          ,area: '350px;'
          ,shade: 0.8
          ,id: 'LAY_layuipro' //设定一个id，防止重复弹出
          ,btn: ['带朕去看看', '给朕退下']
          ,btnAlign: 'c'
          ,moveType: 1 //拖拽模式，0或者1
          ,content: '<div style="padding: 50px; line-height: 22px; background-color: #393D49; color: #fff; font-size:13px; font-weight: 300;">你知道吗？阿里云的采购季来了！！！<br/><br/>云产品低至<b>0.75折</b> </br></br>ECS服务器最低 <b>¥74.43</b>/年 ...<br><br>MySQL云数据库最低 <b>¥188</b>/年 ...<br><br>1.5万条的短信只需要 <b>¥540</b> <br/><br/>500G的CDN流量包更是优惠到极致了...</div>'
          ,success: function(layero){
            var btn = layero.find('.layui-layer-btn');
            btn.find('.layui-layer-btn0').attr({
              href: 'https://www.aliyun.com/minisite/goods?userCode=rqxni4zt&share_source=copy_link'
              ,target: '_blank'
            });
          }
        });
    }
  });
</script>-->


    
<div id="container">
  
  <div class="card" style="margin-bottom: 10px">
    
    <div class="card-content article ">
      <!--文章标题-->
      
      <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
        
        <a class="has-link-black-ter" href="/spring-config-import-use-aways.html">SpringBoot使用spring.config.import多种方式导入配置文件</a>
        
      </h1>
      <!--完全自定义页面显示的访问次数-->
      
      
      <div class="level article-meta is-mobile is-overflow-x-auto" style="font-size: 15px">
        <div class="level-left">
          <!--文章类型-->
          
          
          
          <span
            style="float: left;padding: 1px 2px 1px 2px;margin-right: 5px;background-color: #5cb85c;color: white;text-align: center;border-radius:0.25em;font-size: 14px">
            原创</span>
          
          
          &nbsp;&nbsp;&nbsp;&nbsp;
          <!--发布时间-->
          <img src="/images/date_time.png" style="width: 25px;" title="发布时间"/>
          &nbsp;
          <span class="article-meta-element">2022-04-10</span>
          &nbsp;&nbsp;&nbsp;&nbsp;
          <!--作者-->
          <img src="/images/author.svg" style="width: 23px" title="文章作者"/>

          <span class="article-meta-element">于起宇</span>
          &nbsp;&nbsp;&nbsp;&nbsp;
          <!--目录列表-->
          
          <img src="/images/categories.svg" style="width: 20px;" title="文章所属目录列表"/>
          &nbsp;
          <div class="level-item article-meta-element">
            <!--读取config.yml文件内的目录配置-->
            
            
              
                
                  <!--跳转文章目录地址-->
                  <a class="category-link" href="/spring-boot-all-articles.html">SpringBoot</a>&nbsp;
                
              
                
              
                
              
                
              
            
          </div>
          
          <!--不蒜子统计阅读量-->
          <!---->
        </div>
      </div>
      
      
      <!--推荐阅读 - 新闻-->
      
      <!--文章内容-->
      <div class="content">
        <h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p><code>SpringBoot</code>从2.4.x版本开始支持了导入文件的方式来加载配置参数，与<code>spring.config.additional-location</code>不同的是不用提前设置而且支持导入的文件类型相对来说要丰富很多。</p>
<p>我们只需要在<code>application.properties/application.yml</code>配置文件中通过<code>spring.config.import</code>属性配置需要导入的文件列表即可。</p>
<p>通过<code>spring.config.import</code>属性支持导入多种途径的配置文件，下面简单介绍几种。</p>
<h2 id="导入classpath下的配置文件"><a href="#导入classpath下的配置文件" class="headerlink" title="导入classpath下的配置文件"></a>导入classpath下的配置文件</h2><p>可以导入<code>classpath</code>下任意目录的文件，使用方式如下所示：</p>
<figure class="highlight yaml hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-attr">spring:</span></span><br><span class="line">  <span class="hljs-attr">config:</span></span><br><span class="line">    <span class="hljs-attr">import:</span></span><br><span class="line">    <span class="hljs-comment"># 导入classpath下default目录下的default.properties配置文件</span></span><br><span class="line">    <span class="hljs-bullet">-</span> <span class="hljs-string">classpath:/default/default.properties</span></span><br><span class="line">    <span class="hljs-comment"># 导入classpath下service目录下的service.yml配置文件</span></span><br><span class="line">    <span class="hljs-bullet">-</span> <span class="hljs-string">classpath:/service/service.yml</span></span><br></pre></td></tr></table></figure>

<p>在<code>src/main/resource</code>下分别创建<code>default</code>、<code>service</code>目录，在<code>default</code>目录下创建<code>default.properties</code>、在<code>service</code>目录下创建<code>sevice.yml</code>。</p>
<p>通过上面配置的属性导入后我们直接就可以在项目中通过<code>@ConfigurationProperties</code>或<code>@Value</code>来注入使用。</p>
<blockquote>
<p><code>src/main/resource</code>、<code>src/main/java</code>目录编译后都会到<code>classpath</code>根目录下。</p>
</blockquote>
<figure class="highlight yaml hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-string">//</span> <span class="hljs-string">default.properties</span></span><br><span class="line"><span class="hljs-string">default.password=111111</span></span><br><span class="line"><span class="hljs-string">//</span> <span class="hljs-string">service.yml</span></span><br><span class="line"><span class="hljs-attr">service:</span></span><br><span class="line">  <span class="hljs-attr">id:</span> <span class="hljs-string">example</span></span><br><span class="line">  <span class="hljs-attr">port:</span> <span class="hljs-number">9999</span></span><br><span class="line">  <span class="hljs-attr">index-path:</span> <span class="hljs-string">/index</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">// default.properties</span></span><br><span class="line"><span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;default.password&#125;"</span>)</span><br><span class="line"><span class="hljs-keyword">private</span> String defaultPassword;</span><br><span class="line">---</span><br><span class="line"><span class="hljs-comment">// service.yml</span></span><br><span class="line"><span class="hljs-meta">@Configuration</span></span><br><span class="line"><span class="hljs-meta">@ConfigurationProperties</span>(prefix = <span class="hljs-string">"service"</span>)</span><br><span class="line"><span class="hljs-meta">@Data</span></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ServiceProperties</span> </span>&#123;</span><br><span class="line">    <span class="hljs-keyword">private</span> String id;</span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> port;</span><br><span class="line">    <span class="hljs-keyword">private</span> String indexPath;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="导入系统目录下的配置文件"><a href="#导入系统目录下的配置文件" class="headerlink" title="导入系统目录下的配置文件"></a>导入系统目录下的配置文件</h2><p>可以导入操作系统目录下的配置文件，我在<code>/Users/yuqiyu/Downloads</code>目录下创建了名为<code>system.properties</code>的文件，导入方式如下所示：</p>
<figure class="highlight yaml hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-attr">spring:</span></span><br><span class="line">  <span class="hljs-attr">config:</span></span><br><span class="line">    <span class="hljs-attr">import:</span></span><br><span class="line">    <span class="hljs-comment"># 导入系统目录/Users/yuqiyu/Downloads下的system.properties配置文件</span></span><br><span class="line">    <span class="hljs-bullet">-</span> <span class="hljs-string">optional:/Users/yuqiyu/Downloads/system.properties</span></span><br></pre></td></tr></table></figure>

<p>使用<code>@ConfigurationProperties</code>方式注入映射如下所示：</p>
<figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">// system.properties</span></span><br><span class="line">system.os=osx</span><br><span class="line">system.jdk-version=<span class="hljs-number">11</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// SystemProperties.java</span></span><br><span class="line"><span class="hljs-meta">@Data</span></span><br><span class="line"><span class="hljs-meta">@Configuration</span></span><br><span class="line"><span class="hljs-meta">@ConfigurationProperties</span>(prefix = <span class="hljs-string">"system"</span>)</span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SystemProperties</span> </span>&#123;</span><br><span class="line">    <span class="hljs-keyword">private</span> String os;</span><br><span class="line">    <span class="hljs-keyword">private</span> String jdkVersion;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="导入Nacos配置中心的配置文件"><a href="#导入Nacos配置中心的配置文件" class="headerlink" title="导入Nacos配置中心的配置文件"></a>导入Nacos配置中心的配置文件</h2><p><code>Nacos</code>在<code>SpringCloud Alibaba</code>发布了<code>2021.0.1.0</code>版本后对<code>spring.config.import</code>做了支持，可以直接通过加载<code>Nacos Server</code>内指定的配置文件。</p>
<p>首先我们使用<code>Docker</code>来创建一个<code>Nacos Server</code>容器，步骤如下所示：</p>
<figure class="highlight bash hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment"># 拉取nacos-server镜像</span></span><br><span class="line">docker pull nacos/nacos-server</span><br><span class="line"><span class="hljs-comment"># 创建并启动nacos-server容器</span></span><br><span class="line">docker run --name nacos-quick -e MODE=standalone -p 8848:8848 -p 9848:9848 -d nacos/nacos-server:latest</span><br></pre></td></tr></table></figure>

<p>访问<a href="http://localhost:8848/nacos" target="_blank" rel="noopener">http://localhost:8848/nacos</a>，使用默认账号<code>nacos</code>登录后在<code>public</code>命名空间下创建一个名为<code>spring-config-import-example.yaml</code>的<code>YAML</code>格式的配置文件，内容如下所示：</p>
<figure class="highlight yaml hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-attr">config:</span></span><br><span class="line">    <span class="hljs-attr">source:</span> <span class="hljs-string">nacos</span></span><br></pre></td></tr></table></figure>

<p>在<code>SpringBoot</code>项目中如果需要集成<code>nacos</code>，可以直接添加<code>spring-cloud-starter-alibaba-nacos-config</code>依赖，如下所示：</p>
<figure class="highlight xml hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-config<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2021.0.1.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>导入方式如下所示：</p>
<figure class="highlight yaml hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-attr">spring:</span></span><br><span class="line">  <span class="hljs-attr">cloud:</span></span><br><span class="line">    <span class="hljs-attr">nacos:</span></span><br><span class="line">      <span class="hljs-attr">server-addr:</span> <span class="hljs-string">localhost:8848</span></span><br><span class="line">  <span class="hljs-attr">config:</span></span><br><span class="line">    <span class="hljs-attr">import:</span></span><br><span class="line">    <span class="hljs-comment"># 导入nacos配置中心的配置文件</span></span><br><span class="line">    <span class="hljs-bullet">-</span> <span class="hljs-string">optional:nacos:spring-config-import-example.yaml</span></span><br></pre></td></tr></table></figure>

<p>在项目中同样可以使用<code>@ConfigurationProperties</code>、<code>@Value</code>来注入配置参数，如下所示：</p>
<figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;config.source&#125;"</span>)</span><br><span class="line"><span class="hljs-keyword">private</span> String configSource;</span><br></pre></td></tr></table></figure>

<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p><code>spring.config.import</code>使用方式是多样化的，如果你需要自定义导入的方式，可以借鉴<code>nacos</code>对其实现的部分代码。</p>

        
        <!--原创-->
        
        <!--转载标注-->
        
        
      </div>
      <!--文章标签-->
      
      
      
    </div>
  </div>

  
  

  
  <!--评论-->
  
  
</div>

<script src="/js/readmore.js" type="text/javascript"></script>
<script>
  const btw = new BTWPlugin();
  btw.init({
    id: 'container',
    blogId: '10034-1569731208928-426',
    name: '恒宇少年',
    qrcode: 'https://blog.yuqiyu.com/images/mp.jpg',
    keyword: 'free',
  });
</script>

<!--<script src="/js/layui.js"></script>
<script>
  layui.use(['layer'], function () {
    var layer = layui.layer;
    var isShowOnce = localStorage.getItem('isShowHistory');
    if (!isShowOnce) {
      localStorage.setItem('isShowHistory',true);
      layer.open({
          type: 1
          ,title: false //不显示标题栏
          ,closeBtn: false
          ,area: '350px;'
          ,shade: 0.8
          ,id: 'LAY_layuipro' //设定一个id，防止重复弹出
          ,btn: ['带朕去看看', '给朕退下']
          ,btnAlign: 'c'
          ,moveType: 1 //拖拽模式，0或者1
          ,content: '<div style="padding: 50px; line-height: 22px; background-color: #393D49; color: #fff; font-size:13px; font-weight: 300;">你知道吗？阿里云的采购季来了！！！<br/><br/>云产品低至<b>0.75折</b> </br></br>ECS服务器最低 <b>¥74.43</b>/年 ...<br><br>MySQL云数据库最低 <b>¥188</b>/年 ...<br><br>1.5万条的短信只需要 <b>¥540</b> <br/><br/>500G的CDN流量包更是优惠到极致了...</div>'
          ,success: function(layero){
            var btn = layero.find('.layui-layer-btn');
            btn.find('.layui-layer-btn0').attr({
              href: 'https://www.aliyun.com/minisite/goods?userCode=rqxni4zt&share_source=copy_link'
              ,target: '_blank'
            });
          }
        });
    }
  });
</script>-->


    
<div id="container">
  
  <div class="card" style="margin-bottom: 10px">
    
    <div class="card-content article ">
      <!--文章标题-->
      
      <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
        
        <a class="has-link-black-ter" href="/oauth2-always-create-token.html">Spring OAuth2 实现始终获取新的令牌</a>
        
      </h1>
      <!--完全自定义页面显示的访问次数-->
      
      
      <div class="level article-meta is-mobile is-overflow-x-auto" style="font-size: 15px">
        <div class="level-left">
          <!--文章类型-->
          
          
          
          <span
            style="float: left;padding: 1px 2px 1px 2px;margin-right: 5px;background-color: #5cb85c;color: white;text-align: center;border-radius:0.25em;font-size: 14px">
            原创</span>
          
          
          &nbsp;&nbsp;&nbsp;&nbsp;
          <!--发布时间-->
          <img src="/images/date_time.png" style="width: 25px;" title="发布时间"/>
          &nbsp;
          <span class="article-meta-element">2021-04-21</span>
          &nbsp;&nbsp;&nbsp;&nbsp;
          <!--作者-->
          <img src="/images/author.svg" style="width: 23px" title="文章作者"/>

          <span class="article-meta-element">于起宇</span>
          &nbsp;&nbsp;&nbsp;&nbsp;
          <!--目录列表-->
          
          <img src="/images/categories.svg" style="width: 20px;" title="文章所属目录列表"/>
          &nbsp;
          <div class="level-item article-meta-element">
            <!--读取config.yml文件内的目录配置-->
            
            
              
                
                  <!--跳转文章目录地址-->
                  <a class="category-link" href="/spring-boot-all-articles.html">SpringBoot</a>&nbsp;
                
              
                
              
                
              
                
              
            
          </div>
          
          <!--不蒜子统计阅读量-->
          <!---->
        </div>
      </div>
      
      
      <!--推荐阅读 - 新闻-->
      
      <!--文章内容-->
      <div class="content">
        <p><code>Spring</code>基于<code>OAuth2</code>协议编写的<code>spring-oauth2</code>实现，是行业级的接口资源安全解决方案，我们可以基于该依赖配置不同客户端的不同权限来访问接口数据。</p>
<h2 id="默认令牌生成方式"><a href="#默认令牌生成方式" class="headerlink" title="默认令牌生成方式"></a>默认令牌生成方式</h2><p>每当我们获取请求令牌（<code>access_token</code>）时，默认情况返回第一次生成的令牌，使用同一个用户多次获取令牌时，只有过期时间在缩短，其它的内容不变。</p>
<p>这种方式有利有弊，如果同一个账户只能有一个人登录，这样是没有任何问题的，但是如果同一个账号可以让多个人同时登录，那么就会存在一定的问题。</p>
<p>比如我们现在有一个名为<code>hengboy</code>的账户：第一个人登录时令牌有效期为我们配置的最长有效期（假设为<code>7200</code>秒），这时又有第二个人登录的同一个用户，第二个人获取的令牌并不会重置有效期（可能还剩下<code>3000</code>秒），对于<strong>这种结果并不是我们期望的</strong>。</p>
<h3 id="原因分析"><a href="#原因分析" class="headerlink" title="原因分析"></a>原因分析</h3><p>目前<code>spring-oauth2</code>依赖内集成了三种存储令牌的方式，分别是：<code>InMemoryTokenStore（内存方式）</code>、<code>RedisTokenStore（Redis方式）</code>、<code>JdbcTokenStore（数据库方式）</code>。</p>
<p>从阅读源码中可以发现无论我们配置使用什么方式来进行存储令牌，同一个账户的有效令牌只会存在一个，结合上面的场景来思考所以第二个人获取的令牌与第一个人是同一个。</p>
<h3 id="DefaultTokenServices"><a href="#DefaultTokenServices" class="headerlink" title="DefaultTokenServices"></a>DefaultTokenServices</h3><p><code>DefaultTokenServices</code>令牌服务是<code>AuthorizationServerTokenServices</code>接口的默认实现，位于<code>org.springframework.security.oauth2.provider.token</code>包内，提供了默认的操作令牌的方法，常用的有：</p>
<ul>
<li><code>createAccessToken</code>：根据客户端信息、登录用户信息来创建请求令牌（<code>access_token</code>）以及刷新令牌（<code>refresh_token</code>）</li>
<li><code>refreshAccessToken</code>：根据刷新令牌（<code>refresh_token</code>）来获取一个全新的请求令牌（<code>access_token</code>）</li>
<li><code>revokeToken</code>：撤销令牌，删除用户生成的请求令牌（<code>access_token</code>）、刷新令牌（<code>refresh_token</code>）</li>
</ul>
<h3 id="源码解析：生成令牌"><a href="#源码解析：生成令牌" class="headerlink" title="源码解析：生成令牌"></a>源码解析：生成令牌</h3><p><strong>DefaultTokenServices#createAccessToken：</strong></p>
<figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">@Transactional</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> OAuth2AccessToken <span class="hljs-title">createAccessToken</span><span class="hljs-params">(OAuth2Authentication authentication)</span> <span class="hljs-keyword">throws</span> AuthenticationException </span>&#123;</span><br><span class="line">        OAuth2AccessToken existingAccessToken = <span class="hljs-keyword">this</span>.tokenStore.getAccessToken(authentication);</span><br><span class="line">        OAuth2RefreshToken refreshToken = <span class="hljs-keyword">null</span>;</span><br><span class="line">        <span class="hljs-keyword">if</span> (existingAccessToken != <span class="hljs-keyword">null</span>) &#123;</span><br><span class="line">            <span class="hljs-keyword">if</span> (!existingAccessToken.isExpired()) &#123;</span><br><span class="line">                <span class="hljs-keyword">this</span>.tokenStore.storeAccessToken(existingAccessToken, authentication);</span><br><span class="line">                <span class="hljs-keyword">return</span> existingAccessToken;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="hljs-keyword">if</span> (existingAccessToken.getRefreshToken() != <span class="hljs-keyword">null</span>) &#123;</span><br><span class="line">                refreshToken = existingAccessToken.getRefreshToken();</span><br><span class="line">                <span class="hljs-keyword">this</span>.tokenStore.removeRefreshToken(refreshToken);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="hljs-keyword">this</span>.tokenStore.removeAccessToken(existingAccessToken);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">if</span> (refreshToken == <span class="hljs-keyword">null</span>) &#123;</span><br><span class="line">            refreshToken = <span class="hljs-keyword">this</span>.createRefreshToken(authentication);</span><br><span class="line">        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (refreshToken <span class="hljs-keyword">instanceof</span> ExpiringOAuth2RefreshToken) &#123;</span><br><span class="line">            ExpiringOAuth2RefreshToken expiring = (ExpiringOAuth2RefreshToken)refreshToken;</span><br><span class="line">            <span class="hljs-keyword">if</span> (System.currentTimeMillis() &gt; expiring.getExpiration().getTime()) &#123;</span><br><span class="line">                refreshToken = <span class="hljs-keyword">this</span>.createRefreshToken(authentication);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        OAuth2AccessToken accessToken = <span class="hljs-keyword">this</span>.createAccessToken(authentication, refreshToken);</span><br><span class="line">        <span class="hljs-keyword">this</span>.tokenStore.storeAccessToken(accessToken, authentication);</span><br><span class="line">        refreshToken = accessToken.getRefreshToken();</span><br><span class="line">        <span class="hljs-keyword">if</span> (refreshToken != <span class="hljs-keyword">null</span>) &#123;</span><br><span class="line">            <span class="hljs-keyword">this</span>.tokenStore.storeRefreshToken(refreshToken, authentication);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">return</span> accessToken;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>在创建令牌的源码方法中，首先根据认证信息去读取存储介质（<code>TokenStore</code>实现类）内该账户的令牌，如果令牌已经存储并且并未过期，则直接返回（<code>这也就是同一个账户不同人登录时返回同一个令牌的逻辑</code>），如果令牌已经过期，则删除刷新令牌（<code>refresh_token</code>）、请求令牌（<code>access_token</code>）后重新生成。</p>
<h3 id="源码解析：刷新令牌"><a href="#源码解析：刷新令牌" class="headerlink" title="源码解析：刷新令牌"></a>源码解析：刷新令牌</h3><p><strong>DefaultTokenServices#refreshAccessToken：</strong></p>
<figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">@Transactional</span>(</span><br><span class="line">        noRollbackFor = &#123;InvalidTokenException<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">InvalidGrantException</span>.<span class="hljs-title">class</span>&#125;</span></span><br><span class="line"><span class="hljs-class">    )</span></span><br><span class="line"><span class="hljs-class">    <span class="hljs-title">public</span> <span class="hljs-title">OAuth2AccessToken</span> <span class="hljs-title">refreshAccessToken</span>(<span class="hljs-title">String</span> <span class="hljs-title">refreshTokenValue</span>, <span class="hljs-title">TokenRequest</span> <span class="hljs-title">tokenRequest</span>) <span class="hljs-title">throws</span> <span class="hljs-title">AuthenticationException</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.supportRefreshToken) &#123;</span><br><span class="line">            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InvalidGrantException(<span class="hljs-string">"Invalid refresh token: "</span> + refreshTokenValue);</span><br><span class="line">        &#125; <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">            OAuth2RefreshToken refreshToken = <span class="hljs-keyword">this</span>.tokenStore.readRefreshToken(refreshTokenValue);</span><br><span class="line">            <span class="hljs-keyword">if</span> (refreshToken == <span class="hljs-keyword">null</span>) &#123;</span><br><span class="line">                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InvalidGrantException(<span class="hljs-string">"Invalid refresh token: "</span> + refreshTokenValue);</span><br><span class="line">            &#125; <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">                OAuth2Authentication authentication = <span class="hljs-keyword">this</span>.tokenStore.readAuthenticationForRefreshToken(refreshToken);</span><br><span class="line">                <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.authenticationManager != <span class="hljs-keyword">null</span> &amp;&amp; !authentication.isClientOnly()) &#123;</span><br><span class="line">                    Authentication userAuthentication = authentication.getUserAuthentication();</span><br><span class="line">                    PreAuthenticatedAuthenticationToken preAuthenticatedToken = <span class="hljs-keyword">new</span> PreAuthenticatedAuthenticationToken(userAuthentication, <span class="hljs-string">""</span>, authentication.getAuthorities());</span><br><span class="line">                    <span class="hljs-keyword">if</span> (userAuthentication.getDetails() != <span class="hljs-keyword">null</span>) &#123;</span><br><span class="line">                        preAuthenticatedToken.setDetails(userAuthentication.getDetails());</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    Authentication user = <span class="hljs-keyword">this</span>.authenticationManager.authenticate(preAuthenticatedToken);</span><br><span class="line">                    Object details = authentication.getDetails();</span><br><span class="line">                    authentication = <span class="hljs-keyword">new</span> OAuth2Authentication(authentication.getOAuth2Request(), user);</span><br><span class="line">                    authentication.setDetails(details);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                String clientId = authentication.getOAuth2Request().getClientId();</span><br><span class="line">                <span class="hljs-keyword">if</span> (clientId != <span class="hljs-keyword">null</span> &amp;&amp; clientId.equals(tokenRequest.getClientId())) &#123;</span><br><span class="line">                    <span class="hljs-keyword">this</span>.tokenStore.removeAccessTokenUsingRefreshToken(refreshToken);</span><br><span class="line">                    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.isExpired(refreshToken)) &#123;</span><br><span class="line">                        <span class="hljs-keyword">this</span>.tokenStore.removeRefreshToken(refreshToken);</span><br><span class="line">                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InvalidTokenException(<span class="hljs-string">"Invalid refresh token (expired): "</span> + refreshToken);</span><br><span class="line">                    &#125; <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">                        authentication = <span class="hljs-keyword">this</span>.createRefreshedAuthentication(authentication, tokenRequest);</span><br><span class="line">                        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.reuseRefreshToken) &#123;</span><br><span class="line">                            <span class="hljs-keyword">this</span>.tokenStore.removeRefreshToken(refreshToken);</span><br><span class="line">                            refreshToken = <span class="hljs-keyword">this</span>.createRefreshToken(authentication);</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        OAuth2AccessToken accessToken = <span class="hljs-keyword">this</span>.createAccessToken(authentication, refreshToken);</span><br><span class="line">                        <span class="hljs-keyword">this</span>.tokenStore.storeAccessToken(accessToken, authentication);</span><br><span class="line">                        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.reuseRefreshToken) &#123;</span><br><span class="line">                            <span class="hljs-keyword">this</span>.tokenStore.storeRefreshToken(accessToken.getRefreshToken(), authentication);</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="hljs-keyword">return</span> accessToken;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InvalidGrantException(<span class="hljs-string">"Wrong client for this refresh token: "</span> + refreshTokenValue);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>在刷新令牌的源码方法中，首先需要读取刷新令牌（<code>refresh_token</code>）的具体内容，如果不存在则直接抛出刷新令牌无效的异常<code>InvalidGrantException</code>。</p>
<p>执行令牌刷新之前，需要根据刷新令牌删除请求令牌<code>removeAccessTokenUsingRefreshToken</code>，删除后再次判定刷新令牌是否失效，如果失效抛出<code>InvalidTokenException</code>异常。</p>
<p>刷新令牌的重复使用是根据全局变量<code>reuseRefreshToken</code>来判定的，默认情况下该变量的值为<code>true</code>，也就是刷新令牌可以重复使用，但是经过<code>createAccessToken &gt; TokenEnhancer#enhance</code>处理后刷新令牌会被重新创建并替换（这个地方貌似是一个Bug）。</p>
<h2 id="重写TokenServices"><a href="#重写TokenServices" class="headerlink" title="重写TokenServices"></a>重写TokenServices</h2><h3 id="期望效果"><a href="#期望效果" class="headerlink" title="期望效果"></a>期望效果</h3><p>假设请求令牌（<code>access_token</code>）的有效期为<code>7200</code>秒，也就是<code>2</code>个小时，刷新令牌（<code>refresh_token</code>）的有效期为<code>43200</code>秒，也就是<code>12</code>个小时。</p>
<p>在第一次通过<code>createAccessToken</code>获取令牌后，每次请求令牌（<code>access_token</code>）过期后通过刷新的方式（<code>/oauth/token?grant_type=refresh_token</code>）重新获取一次新的（<code>有效期为2个小时</code>）请求令牌，当刷新令牌（<code>refresh_token</code>）失效后，再次通过<code>createAccessToken</code>方法来获取令牌。</p>
<h3 id="分析期望效果"><a href="#分析期望效果" class="headerlink" title="分析期望效果"></a>分析期望效果</h3><p>针对上面的期望效果我们需要修改<code>createAccessToken</code>、<code>refreshAccessToken</code>两个方法的源码，调用<code>createAccessToken</code>方法时不再判定是否使用已经存在的有效令牌，而调用<code>refreshAccessToken</code>方法时需要删除响应的<code>refresh_token</code>的返回字段并把新的请求令牌与刷新令牌进行绑定。</p>
<h3 id="OverrideTokenServices"><a href="#OverrideTokenServices" class="headerlink" title="OverrideTokenServices"></a>OverrideTokenServices</h3><p>复制<code>DefaultTokenServices</code>类内的全部代码，创建一个名为<code>OverrideTokenServices</code>的类，为了兼容原来的逻辑，需要添加一个全局变量<code>alwaysCreateToken</code>，用于判定是否始终创建令牌。</p>
<h3 id="重写创建令牌逻辑"><a href="#重写创建令牌逻辑" class="headerlink" title="重写创建令牌逻辑"></a>重写创建令牌逻辑</h3><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">@Transactional</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> OAuth2AccessToken <span class="hljs-title">createAccessToken</span><span class="hljs-params">(OAuth2Authentication authentication)</span> <span class="hljs-keyword">throws</span> AuthenticationException </span>&#123;</span><br><span class="line">        OAuth2RefreshToken refreshToken = <span class="hljs-keyword">null</span>;</span><br><span class="line">        OAuth2AccessToken existingAccessToken = <span class="hljs-keyword">this</span>.tokenStore.getAccessToken(authentication);</span><br><span class="line">        <span class="hljs-comment">// 根据alwaysCreateToken字段判定是否始终创建令牌</span></span><br><span class="line">        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.alwaysCreateToken &amp;&amp; existingAccessToken != <span class="hljs-keyword">null</span>) &#123;</span><br><span class="line">            <span class="hljs-keyword">if</span> (!existingAccessToken.isExpired()) &#123;</span><br><span class="line">                <span class="hljs-keyword">this</span>.tokenStore.storeAccessToken(existingAccessToken, authentication);</span><br><span class="line">                <span class="hljs-keyword">return</span> existingAccessToken;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="hljs-keyword">if</span> (existingAccessToken.getRefreshToken() != <span class="hljs-keyword">null</span>) &#123;</span><br><span class="line">                refreshToken = existingAccessToken.getRefreshToken();</span><br><span class="line">                <span class="hljs-keyword">this</span>.tokenStore.removeRefreshToken(refreshToken);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="hljs-keyword">this</span>.tokenStore.removeAccessToken(existingAccessToken);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="hljs-keyword">if</span> (refreshToken == <span class="hljs-keyword">null</span>) &#123;</span><br><span class="line">            refreshToken = <span class="hljs-keyword">this</span>.createRefreshToken(authentication);</span><br><span class="line">        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (refreshToken <span class="hljs-keyword">instanceof</span> ExpiringOAuth2RefreshToken) &#123;</span><br><span class="line">            ExpiringOAuth2RefreshToken expiring = (ExpiringOAuth2RefreshToken)refreshToken;</span><br><span class="line">            <span class="hljs-keyword">if</span> (System.currentTimeMillis() &gt; expiring.getExpiration().getTime()) &#123;</span><br><span class="line">                refreshToken = <span class="hljs-keyword">this</span>.createRefreshToken(authentication);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        OAuth2AccessToken accessToken = <span class="hljs-keyword">this</span>.createAccessToken(authentication, refreshToken);</span><br><span class="line">        <span class="hljs-keyword">this</span>.tokenStore.storeAccessToken(accessToken, authentication);</span><br><span class="line">        refreshToken = accessToken.getRefreshToken();</span><br><span class="line">        <span class="hljs-keyword">if</span> (refreshToken != <span class="hljs-keyword">null</span>) &#123;</span><br><span class="line">            <span class="hljs-keyword">this</span>.tokenStore.storeRefreshToken(refreshToken, authentication);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">return</span> accessToken;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>如果我们想使用原来的逻辑，在初始化<code>OverrideTokenServices</code>类时需要设置<code>alwaysCreateToken</code>变量的值为<code>false</code>。</p>
</blockquote>
<h3 id="重写刷新令牌逻辑"><a href="#重写刷新令牌逻辑" class="headerlink" title="重写刷新令牌逻辑"></a>重写刷新令牌逻辑</h3><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">public</span> OAuth2AccessToken <span class="hljs-title">refreshAccessToken</span><span class="hljs-params">(String refreshTokenValue, TokenRequest tokenRequest)</span> <span class="hljs-keyword">throws</span> AuthenticationException </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.supportRefreshToken) &#123;</span><br><span class="line">            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InvalidGrantException(<span class="hljs-string">"Invalid refresh token: "</span> + refreshTokenValue);</span><br><span class="line">        &#125; <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">            OAuth2RefreshToken refreshToken = <span class="hljs-keyword">this</span>.tokenStore.readRefreshToken(refreshTokenValue);</span><br><span class="line">            <span class="hljs-keyword">if</span> (refreshToken == <span class="hljs-keyword">null</span>) &#123;</span><br><span class="line">                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InvalidGrantException(<span class="hljs-string">"Invalid refresh token: "</span> + refreshTokenValue);</span><br><span class="line">            &#125; <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">                OAuth2Authentication authentication = <span class="hljs-keyword">this</span>.tokenStore.readAuthenticationForRefreshToken(refreshToken);</span><br><span class="line">                <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.authenticationManager != <span class="hljs-keyword">null</span> &amp;&amp; !authentication.isClientOnly()) &#123;</span><br><span class="line">                    Authentication userAuthentication = authentication.getUserAuthentication();</span><br><span class="line">                    PreAuthenticatedAuthenticationToken preAuthenticatedToken = <span class="hljs-keyword">new</span> PreAuthenticatedAuthenticationToken(userAuthentication, <span class="hljs-string">""</span>, authentication.getAuthorities());</span><br><span class="line">                    <span class="hljs-keyword">if</span> (userAuthentication.getDetails() != <span class="hljs-keyword">null</span>) &#123;</span><br><span class="line">                        preAuthenticatedToken.setDetails(userAuthentication.getDetails());</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    Authentication user = <span class="hljs-keyword">this</span>.authenticationManager.authenticate(preAuthenticatedToken);</span><br><span class="line">                    Object details = authentication.getDetails();</span><br><span class="line">                    authentication = <span class="hljs-keyword">new</span> OAuth2Authentication(authentication.getOAuth2Request(), user);</span><br><span class="line">                    authentication.setDetails(details);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                String clientId = authentication.getOAuth2Request().getClientId();</span><br><span class="line">                <span class="hljs-keyword">if</span> (clientId != <span class="hljs-keyword">null</span> &amp;&amp; clientId.equals(tokenRequest.getClientId())) &#123;</span><br><span class="line">                    <span class="hljs-keyword">this</span>.tokenStore.removeAccessTokenUsingRefreshToken(refreshToken);</span><br><span class="line">                    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.isExpired(refreshToken)) &#123;</span><br><span class="line">                        <span class="hljs-keyword">this</span>.tokenStore.removeRefreshToken(refreshToken);</span><br><span class="line">                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InvalidTokenException(<span class="hljs-string">"Invalid refresh token (expired): "</span> + refreshToken);</span><br><span class="line">                    &#125; <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">                        authentication = <span class="hljs-keyword">this</span>.createRefreshedAuthentication(authentication, tokenRequest);</span><br><span class="line">                        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.reuseRefreshToken) &#123;</span><br><span class="line">                            <span class="hljs-keyword">this</span>.tokenStore.removeRefreshToken(refreshToken);</span><br><span class="line">                            refreshToken = <span class="hljs-keyword">this</span>.createRefreshToken(authentication);</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        DefaultOAuth2AccessToken accessToken = (DefaultOAuth2AccessToken) <span class="hljs-keyword">this</span>.createAccessToken(authentication, refreshToken);</span><br><span class="line">                        <span class="hljs-comment">// If you reuse the refresh token, set the refresh token to the new AccessToken</span></span><br><span class="line">                        <span class="hljs-comment">// 如果重复使用刷新令牌，将刷新令牌与新生成的请求令牌进行绑定</span></span><br><span class="line">                        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.reuseRefreshToken) &#123;</span><br><span class="line">                            accessToken.setRefreshToken(refreshToken);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="hljs-keyword">this</span>.tokenStore.storeAccessToken(accessToken, authentication);</span><br><span class="line">                        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.reuseRefreshToken) &#123;</span><br><span class="line">                            <span class="hljs-keyword">this</span>.tokenStore.storeRefreshToken(accessToken.getRefreshToken(), authentication);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="hljs-comment">// No new token will be returned after refresh</span></span><br><span class="line">                        <span class="hljs-comment">// 刷新令牌后不再返回refresh_token</span></span><br><span class="line">                        accessToken.setRefreshToken(<span class="hljs-keyword">null</span>);</span><br><span class="line">                        <span class="hljs-keyword">return</span> accessToken;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InvalidGrantException(<span class="hljs-string">"Wrong client for this refresh token: "</span> + refreshTokenValue);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>在<code>DefaultTokenServices</code>类中默认定义了全局变量<code>reuseRefreshToken</code>，该变量的值为<code>true</code>，表示默认情况下刷新令牌（<code>refresh_token</code>）是可以重复使用的，一般刷新令牌的过期时间都比较久，当请求令牌（<code>access_token</code>）失效后根据刷新令牌进行获取新的有效请求令牌。</p>
<h2 id="配置TokenServices"><a href="#配置TokenServices" class="headerlink" title="配置TokenServices"></a>配置TokenServices</h2><p>我们需要在<code>AuthorizationServerConfigurerAdapter</code>实现类内进行配置<code>TokenServices</code>的替换使用，如下所示：</p>
<figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">  * 实例化&#123;<span class="hljs-doctag">@link</span> OverrideTokenServices&#125;</span></span><br><span class="line"><span class="hljs-comment">  *</span></span><br><span class="line"><span class="hljs-comment">  * <span class="hljs-doctag">@return</span> &#123;<span class="hljs-doctag">@link</span> OverrideTokenServices&#125;</span></span><br><span class="line"><span class="hljs-comment">  */</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">private</span> AuthorizationServerTokenServices <span class="hljs-title">tokenServices</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">  OverrideTokenServices tokenServices = <span class="hljs-keyword">new</span> OverrideTokenServices();</span><br><span class="line">  tokenServices.setTokenStore(tokenStore());</span><br><span class="line">  tokenServices.setAlwaysCreateToken(<span class="hljs-keyword">true</span>);</span><br><span class="line">  tokenServices.setSupportRefreshToken(<span class="hljs-keyword">true</span>);</span><br><span class="line">  tokenServices.setClientDetailsService(clientDetailsService);</span><br><span class="line">  <span class="hljs-keyword">return</span> tokenServices;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-meta">@Override</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(AuthorizationServerEndpointsConfigurer endpoints)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;</span><br><span class="line">  endpoints</span><br><span class="line">    .authenticationManager(authenticationManager)</span><br><span class="line">    .tokenStore(tokenStore())</span><br><span class="line">    <span class="hljs-comment">// 配置替换使用TokenServices</span></span><br><span class="line">    .tokenServices(tokenServices());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p><strong>获取令牌示例：</strong></p>
<figure class="highlight sh hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">第一次获取令牌：</span><br><span class="line">yuqiyu@hengyu ~&gt; curl -X POST -u <span class="hljs-string">"local:123456"</span> http://localhost:9091/oauth/token -d <span class="hljs-string">"grant_type=password&amp;username=hengboy&amp;password=123456"</span> | jsonpp</span><br><span class="line">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span><br><span class="line">                                 Dload  Upload   Total   Spent    Left  Speed</span><br><span class="line">100   199    0   147  100    52    362    128 --:--:-- --:--:-- --:--:--   491</span><br><span class="line">&#123;</span><br><span class="line">  <span class="hljs-string">"access_token"</span>: <span class="hljs-string">"qoL7Kg33-deYw-aw8PnIKK-qxEk"</span>,</span><br><span class="line">  <span class="hljs-string">"token_type"</span>: <span class="hljs-string">"bearer"</span>,</span><br><span class="line">  <span class="hljs-string">"refresh_token"</span>: <span class="hljs-string">"-OfFqllKZJC6-r_v_uR9KGUBXl0"</span>,</span><br><span class="line">  <span class="hljs-string">"expires_in"</span>: 7199,</span><br><span class="line">  <span class="hljs-string">"scope"</span>: <span class="hljs-string">"read"</span></span><br><span class="line">&#125;</span><br><span class="line">第二次获取令牌：</span><br><span class="line">yuqiyu@hengyu ~&gt; curl -X POST -u <span class="hljs-string">"local:123456"</span> http://localhost:9091/oauth/token -d <span class="hljs-string">"grant_type=password&amp;username=hengboy&amp;password=123456"</span> | jsonpp</span><br><span class="line">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span><br><span class="line">                                 Dload  Upload   Total   Spent    Left  Speed</span><br><span class="line">100   199    0   147  100    52    896    317 --:--:-- --:--:-- --:--:--  1213</span><br><span class="line">&#123;</span><br><span class="line">  <span class="hljs-string">"access_token"</span>: <span class="hljs-string">"hfo01xMTVE1xxxbzQLY7vPfLXPE"</span>,</span><br><span class="line">  <span class="hljs-string">"token_type"</span>: <span class="hljs-string">"bearer"</span>,</span><br><span class="line">  <span class="hljs-string">"refresh_token"</span>: <span class="hljs-string">"QuLgm-H3xHzo71M_XSLrglsRs_o"</span>,</span><br><span class="line">  <span class="hljs-string">"expires_in"</span>: 7199,</span><br><span class="line">  <span class="hljs-string">"scope"</span>: <span class="hljs-string">"read"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到上面使用同一个账号获取了两次令牌，而这两次的令牌内容是完全不同的，这也就是实现了针对同一个账号不同人登录时返回新的令牌的需求。</p>
<p><strong>刷新令牌示例：</strong></p>
<figure class="highlight sh hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">根据第一次获取的刷新令牌刷新：</span><br><span class="line">yuqiyu@hengyu ~&gt; curl -X POST -u <span class="hljs-string">"local:123456"</span> http://localhost:9091/oauth/token -d <span class="hljs-string">"grant_type=refresh_token&amp;refresh_token=-OfFqllKZJC6-r_v_uR9KGUBXl0"</span> | jsonpp</span><br><span class="line">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span><br><span class="line">                                 Dload  Upload   Total   Spent    Left  Speed</span><br><span class="line">100   167    0   101  100    66   1109    725 --:--:-- --:--:-- --:--:--  1835</span><br><span class="line">&#123;</span><br><span class="line">  <span class="hljs-string">"access_token"</span>: <span class="hljs-string">"KuOprmzBCzC78NXlTkHvZGs9rhs"</span>,</span><br><span class="line">  <span class="hljs-string">"token_type"</span>: <span class="hljs-string">"bearer"</span>,</span><br><span class="line">  <span class="hljs-string">"expires_in"</span>: 7199,</span><br><span class="line">  <span class="hljs-string">"scope"</span>: <span class="hljs-string">"read"</span></span><br><span class="line">&#125;</span><br><span class="line">根据第二次获取的刷新令牌刷新：</span><br><span class="line">yuqiyu@hengyu ~&gt; curl -X POST -u <span class="hljs-string">"local:123456"</span> http://localhost:9091/oauth/token -d <span class="hljs-string">"grant_type=refresh_token&amp;refresh_token=QuLgm-H3xHzo71M_XSLrglsRs_o"</span> | jsonpp</span><br><span class="line">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span><br><span class="line">                                 Dload  Upload   Total   Spent    Left  Speed</span><br><span class="line">100   167    0   101  100    66   1122    733 --:--:-- --:--:-- --:--:--  1855</span><br><span class="line">&#123;</span><br><span class="line">  <span class="hljs-string">"access_token"</span>: <span class="hljs-string">"aLPOEkfUCxn87XkTkcwyixaUO1s"</span>,</span><br><span class="line">  <span class="hljs-string">"token_type"</span>: <span class="hljs-string">"bearer"</span>,</span><br><span class="line">  <span class="hljs-string">"expires_in"</span>: 7200,</span><br><span class="line">  <span class="hljs-string">"scope"</span>: <span class="hljs-string">"read"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>同一个账户，上面虽然刷新了两次，但是令牌的有效期不会相互影响</strong>，第一次刷新使用的是第一次获取的刷新令牌，这样其实也就是刷新的第一次的请求令牌，与第二次的无关！！！</p>
</blockquote>
<h2 id="代码示例"><a href="#代码示例" class="headerlink" title="代码示例"></a>代码示例</h2><p>如果您喜欢本篇文章请为源码仓库点个<code>Star</code>，谢谢！！！<br>本篇文章示例源码可以通过以下途径获取，目录为<code>oauth2-always-create-token</code>：</p>
<ul>
<li>Gitee：<a href="https://gitee.com/hengboy/spring-boot-chapter/tree/2.x/" target="_blank" rel="noopener">https://gitee.com/hengboy/spring-boot-chapter</a></li>
</ul>

        
        <!--原创-->
        
        <!--转载标注-->
        
        
      </div>
      <!--文章标签-->
      
      
      
    </div>
  </div>

  
  

  
  <!--评论-->
  
  
</div>

<script src="/js/readmore.js" type="text/javascript"></script>
<script>
  const btw = new BTWPlugin();
  btw.init({
    id: 'container',
    blogId: '10034-1569731208928-426',
    name: '恒宇少年',
    qrcode: 'https://blog.yuqiyu.com/images/mp.jpg',
    keyword: 'free',
  });
</script>

<!--<script src="/js/layui.js"></script>
<script>
  layui.use(['layer'], function () {
    var layer = layui.layer;
    var isShowOnce = localStorage.getItem('isShowHistory');
    if (!isShowOnce) {
      localStorage.setItem('isShowHistory',true);
      layer.open({
          type: 1
          ,title: false //不显示标题栏
          ,closeBtn: false
          ,area: '350px;'
          ,shade: 0.8
          ,id: 'LAY_layuipro' //设定一个id，防止重复弹出
          ,btn: ['带朕去看看', '给朕退下']
          ,btnAlign: 'c'
          ,moveType: 1 //拖拽模式，0或者1
          ,content: '<div style="padding: 50px; line-height: 22px; background-color: #393D49; color: #fff; font-size:13px; font-weight: 300;">你知道吗？阿里云的采购季来了！！！<br/><br/>云产品低至<b>0.75折</b> </br></br>ECS服务器最低 <b>¥74.43</b>/年 ...<br><br>MySQL云数据库最低 <b>¥188</b>/年 ...<br><br>1.5万条的短信只需要 <b>¥540</b> <br/><br/>500G的CDN流量包更是优惠到极致了...</div>'
          ,success: function(layero){
            var btn = layero.find('.layui-layer-btn');
            btn.find('.layui-layer-btn0').attr({
              href: 'https://www.aliyun.com/minisite/goods?userCode=rqxni4zt&share_source=copy_link'
              ,target: '_blank'
            });
          }
        });
    }
  });
</script>-->


    
<div id="container">
  
  <div class="card" style="margin-bottom: 10px">
    
    <div class="card-content article ">
      <!--文章标题-->
      
      <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
        
        <a class="has-link-black-ter" href="/spring-security-flexible-password-encoder.html">Spring Security灵活的PasswordEncoder加密方式</a>
        
      </h1>
      <!--完全自定义页面显示的访问次数-->
      
      
      <div class="level article-meta is-mobile is-overflow-x-auto" style="font-size: 15px">
        <div class="level-left">
          <!--文章类型-->
          
          
          
          <span
            style="float: left;padding: 1px 2px 1px 2px;margin-right: 5px;background-color: #5cb85c;color: white;text-align: center;border-radius:0.25em;font-size: 14px">
            原创</span>
          
          
          &nbsp;&nbsp;&nbsp;&nbsp;
          <!--发布时间-->
          <img src="/images/date_time.png" style="width: 25px;" title="发布时间"/>
          &nbsp;
          <span class="article-meta-element">2020-10-21</span>
          &nbsp;&nbsp;&nbsp;&nbsp;
          <!--作者-->
          <img src="/images/author.svg" style="width: 23px" title="文章作者"/>

          <span class="article-meta-element">于起宇</span>
          &nbsp;&nbsp;&nbsp;&nbsp;
          <!--目录列表-->
          
          <img src="/images/categories.svg" style="width: 20px;" title="文章所属目录列表"/>
          &nbsp;
          <div class="level-item article-meta-element">
            <!--读取config.yml文件内的目录配置-->
            
            
              
                
                  <!--跳转文章目录地址-->
                  <a class="category-link" href="/spring-boot-all-articles.html">SpringBoot</a>&nbsp;
                
              
                
              
                
              
                
              
            
          </div>
          
          <!--不蒜子统计阅读量-->
          <!---->
        </div>
      </div>
      
      
      <!--推荐阅读 - 新闻-->
      
      <!--文章内容-->
      <div class="content">
        <p>本章基于<code>Spring Security 5.4.1</code>版本编写，从<code>5.x</code>版本开始引入了很多新的特性。<br>为了适配老系统的安全框架升级，<code>Spring Security</code>也是费劲了心思，支持不同的密码加密方式，而且根据不同的用户可以使用不同的加密方式。</p>
<h2 id="构建Spring-Security项目"><a href="#构建Spring-Security项目" class="headerlink" title="构建Spring Security项目"></a>构建Spring Security项目</h2><p><code>Spring Security</code>的集成使用还是很简单的，根据项目使用的框架不同大致分为两种集成方式：</p>
<ul>
<li><code>SpringBoot方式集成</code></li>
<li><code>SecurityBom方式集成</code></li>
</ul>
<h3 id="SpringBoot方式构建"><a href="#SpringBoot方式构建" class="headerlink" title="SpringBoot方式构建"></a>SpringBoot方式构建</h3><p>在<code>pom.xml</code>文件内添加如下内容：</p>
<figure class="highlight xml hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="SecurityBom方式构建"><a href="#SecurityBom方式构建" class="headerlink" title="SecurityBom方式构建"></a>SecurityBom方式构建</h3><p><code>spring-security-bom</code>是一个提供了<code>Spring Security</code>指定版本的全部默认依赖的<code>pom</code>类型项目，我们可以通过<code>dependencyManagement</code>进行配置到项目中，这样我们就可以直接添加对应的<code>dependency</code>了（<code>注意：版本号因为bom已经注定，所以dependency不需要指定.</code>）。<br>在<code>pom.xml</code>文件内添加如下内容：</p>
<figure class="highlight xml hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span></span><br><span class="line">  // ...省略其他依赖</span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span></span><br><span class="line">      <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.security<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span></span><br><span class="line">      <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-security-config<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span></span><br><span class="line">      <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.security<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span></span><br><span class="line">      <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-security-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span></span><br><span class="line">      <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.security<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span></span><br><span class="line">      <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-security-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">dependencyManagement</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="hljs-comment">&lt;!--配置SecurityBom--&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span></span><br><span class="line">        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.security<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span></span><br><span class="line">        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-security-bom<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.4.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span></span><br><span class="line">        <span class="hljs-tag">&lt;<span class="hljs-name">type</span>&gt;</span>pom<span class="hljs-tag">&lt;/<span class="hljs-name">type</span>&gt;</span></span><br><span class="line">        <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>import<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">dependencyManagement</span>&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意事项：我们构建Web类型的安全项目时，<code>spring-security-config</code>、<code>spring-security-core</code>、<code>spring-security-web</code>三个依赖都是必须添加的。</p>
</blockquote>
<h2 id="PasswordEncoder"><a href="#PasswordEncoder" class="headerlink" title="PasswordEncoder"></a>PasswordEncoder</h2><p><code>PasswordEncoder</code>是<code>Spring Security</code>提供的密码加密方式的接口定义，源码类如下所示：</p>
<figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">PasswordEncoder</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">	 * Encode the raw password. Generally, a good encoding algorithm applies a SHA-1 or</span></span><br><span class="line"><span class="hljs-comment">	 * greater hash combined with an 8-byte or greater randomly generated salt.</span></span><br><span class="line"><span class="hljs-comment">	 */</span></span><br><span class="line">	<span class="hljs-function">String <span class="hljs-title">encode</span><span class="hljs-params">(CharSequence rawPassword)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">	 * Verify the encoded password obtained from storage matches the submitted raw</span></span><br><span class="line"><span class="hljs-comment">	 * password after it too is encoded. Returns true if the passwords match, false if</span></span><br><span class="line"><span class="hljs-comment">	 * they do not. The stored password itself is never decoded.</span></span><br><span class="line"><span class="hljs-comment">	 *</span></span><br><span class="line"><span class="hljs-comment">	 * <span class="hljs-doctag">@param</span> rawPassword the raw password to encode and match</span></span><br><span class="line"><span class="hljs-comment">	 * <span class="hljs-doctag">@param</span> encodedPassword the encoded password from storage to compare with</span></span><br><span class="line"><span class="hljs-comment">	 * <span class="hljs-doctag">@return</span> true if the raw password, after encoding, matches the encoded password from</span></span><br><span class="line"><span class="hljs-comment">	 * storage</span></span><br><span class="line"><span class="hljs-comment">	 */</span></span><br><span class="line">	<span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">matches</span><span class="hljs-params">(CharSequence rawPassword, String encodedPassword)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">	 * Returns true if the encoded password should be encoded again for better security,</span></span><br><span class="line"><span class="hljs-comment">	 * else false. The default implementation always returns false.</span></span><br><span class="line"><span class="hljs-comment">	 * <span class="hljs-doctag">@param</span> encodedPassword the encoded password to check</span></span><br><span class="line"><span class="hljs-comment">	 * <span class="hljs-doctag">@return</span> true if the encoded password should be encoded again for better security,</span></span><br><span class="line"><span class="hljs-comment">	 * else false.</span></span><br><span class="line"><span class="hljs-comment">	 */</span></span><br><span class="line">	<span class="hljs-function"><span class="hljs-keyword">default</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">upgradeEncoding</span><span class="hljs-params">(String encodedPassword)</span> </span>&#123;</span><br><span class="line">		<span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p><strong>#encode</strong></p>
<p>该方法提供了明文密码的加密处理，加密后密文的格式主要取决于<code>PasswordEncoder</code>接口实现类实例。</p>
</li>
<li><p><strong>#matches</strong></p>
<p>匹配<strong>存储的密码</strong>以及<strong>登录时传递的密码</strong>（<code>登录密码是经过加密处理后的字符串</code>）是否匹配，如果匹配该方法则会返回<code>true</code>.</p>
</li>
</ul>
<h2 id="内置的PasswordEncoder实现列表"><a href="#内置的PasswordEncoder实现列表" class="headerlink" title="内置的PasswordEncoder实现列表"></a>内置的PasswordEncoder实现列表</h2><ul>
<li><p><strong>NoOpPasswordEncoder（已废除）</strong></p>
<p><strong>明文</strong>密码加密方式，该方式已被废除（不建议在生产环境使用），不过还是支持开发阶段测试<code>Spring Security</code>的时候使用。</p>
</li>
<li><p><a href="https://docs.spring.io/spring-security/site/docs/current/reference/html5/#authentication-password-storage-bcrypt" target="_blank" rel="noopener"><strong>BCryptPasswordEncoder</strong></a></p>
</li>
<li><p><a href="https://docs.spring.io/spring-security/site/docs/current/reference/html5/#authentication-password-storage-argon2" target="_blank" rel="noopener"><strong>Argon2PasswordEncoder</strong></a></p>
</li>
<li><p><a href="https://docs.spring.io/spring-security/site/docs/current/reference/html5/#authentication-password-storage-pbkdf2" target="_blank" rel="noopener"><strong>Pbkdf2PasswordEncoder</strong></a></p>
</li>
<li><p><a href="https://docs.spring.io/spring-security/site/docs/current/reference/html5/#authentication-password-storage-scrypt" target="_blank" rel="noopener"><strong>SCryptPasswordEncoder</strong></a></p>
</li>
</ul>
<h2 id="DelegatingPasswordEncoder"><a href="#DelegatingPasswordEncoder" class="headerlink" title="DelegatingPasswordEncoder"></a>DelegatingPasswordEncoder</h2><p>在之前版本集成<code>Spring Secuirty</code>时，我们需要通过<code>@Bean</code>的方式来配置全局统一使用的密码加密方式（<code>PasswordEncoder</code>），当然这种方式现在还是适用的，不过在<code>5.x</code>版本开始为了支持动态的多种密码加密方式，<code>DelegatingPasswordEncoder</code>委托加密方式类应用而生，它内部其实是一个Map集合，根据传递的Key（Key为加密方式）获取Map集合的Value，而Value则是具体的<code>PasswordEncoder</code>实现类。</p>
<p><code>DelegatingPasswordEncoder</code>建立密码格式的规则，格式如：<code>{bcrypt}encodePassword</code>，示例如下所示：</p>
<figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">// &#123;bcrypt&#125;格式会委托给BCryptPasswordEncoder加密类</span></span><br><span class="line">&#123;bcrypt&#125;$<span class="hljs-number">2</span>a$<span class="hljs-number">10</span>$iMz8sMVMiOgRgXRuREF/f.ChT/rpu2ZtitfkT5CkDbZpZlFhLxO3y</span><br><span class="line"><span class="hljs-comment">// &#123;pbkdf2&#125;格式会委托给Pbkdf2PasswordEncoder加密类</span></span><br><span class="line">&#123;pbkdf2&#125;cc409867e39f011f6332bbb6634f58e98d07be7fceefb4cc27e62501594d6ed0b271a25fd9f7fc2e</span><br><span class="line"><span class="hljs-comment">// &#123;MD5&#125;格式会委托给MessageDigestPasswordEncoder加密类</span></span><br><span class="line">&#123;MD5&#125;e10adc3949ba59abbe56e057f20f883e</span><br><span class="line"><span class="hljs-comment">// &#123;noop&#125;明文方式，委托给NoOpPasswordEncoder</span></span><br><span class="line">&#123;noop&#125;<span class="hljs-number">123456</span></span><br><span class="line"><span class="hljs-comment">// ...</span></span><br></pre></td></tr></table></figure>

<h2 id="指定用户使用PasswordEncoder"><a href="#指定用户使用PasswordEncoder" class="headerlink" title="指定用户使用PasswordEncoder"></a>指定用户使用PasswordEncoder</h2><p><code>DelegatingPasswordEncoder</code>是默认的<code>PasswordEncoder</code>加密方式，所以我们可以为不同的用户配置所使用不同的密码加密方式，只需要密码格式按照：<code>{away}encodePassword</code>来进行持久化即可。</p>
<figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">@Configuration</span></span><br><span class="line"><span class="hljs-meta">@EnableWebSecurity</span></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WebSecurityConfiguration</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-meta">@Override</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        http</span><br><span class="line">                .formLogin()</span><br><span class="line">                .and()</span><br><span class="line">                .csrf()</span><br><span class="line">                .disable()</span><br><span class="line">                .authorizeRequests()</span><br><span class="line">                .antMatchers(<span class="hljs-string">"/**"</span>)</span><br><span class="line">                .authenticated();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-meta">@Bean</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> UserDetailsService <span class="hljs-title">users</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">        <span class="hljs-comment">// &#123;MD5&#125;value必须大写，value值必须是32位小写</span></span><br><span class="line">        <span class="hljs-comment">// admin</span></span><br><span class="line">        UserDetails admin = User.builder()</span><br><span class="line">                <span class="hljs-comment">//.passwordEncoder(encoder::encode)</span></span><br><span class="line">                .username(<span class="hljs-string">"admin"</span>).password(</span><br><span class="line">                        <span class="hljs-string">"&#123;MD5&#125;e10adc3949ba59abbe56e057f20f883e"</span></span><br><span class="line">                ).roles(<span class="hljs-string">"admin"</span>).build();</span><br><span class="line"></span><br><span class="line">        <span class="hljs-comment">// hengboy</span></span><br><span class="line">        UserDetails hengboy = User.builder()</span><br><span class="line">                .username(<span class="hljs-string">"hengboy"</span>)</span><br><span class="line">                .password(<span class="hljs-string">"&#123;bcrypt&#125;$2a$10$iMz8sMVMiOgRgXRuREF/f.ChT/rpu2ZtitfkT5CkDbZpZlFhLxO3y"</span>)</span><br><span class="line">                .roles(<span class="hljs-string">"admin"</span>)</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">        <span class="hljs-comment">// yuqiyu</span></span><br><span class="line">        UserDetails yuqiyu = User.builder().username(<span class="hljs-string">"yuqiyu"</span>)</span><br><span class="line">                <span class="hljs-comment">//.password("&#123;noop&#125;123456")</span></span><br><span class="line">                .password(<span class="hljs-string">"&#123;pbkdf2&#125;cc409867e39f011f6332bbb6634f58e98d07be7fceefb4cc27e62501594d6ed0b271a25fd9f7fc2e"</span>)</span><br><span class="line">                .roles(<span class="hljs-string">"user"</span>).build();</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> InMemoryUserDetailsManager(admin, yuqiyu, hengboy);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面是使用内存方式存储安全用户的实现代码，在创建<code>UserDetailsService</code>类的实例时将用户列表通过构造参数进行传递。</p>
<p>所创建的用户：<code>admin</code>，采用<code>MD5</code>的加密方式进行密码编码，这里需要注意的是<strong>MD5加密后的字符串必须为小写32位</strong>。</p>
<p>所创建的用户：<code>hengboy</code>，采用<code>bcrypt</code>方式进行密码编码。</p>
<p>所创建的用户：<code>yuqiyu</code>，采用<code>pbkdf2</code>方式进行密码编码。</p>
<h2 id="覆盖默认的PasswordEncoder"><a href="#覆盖默认的PasswordEncoder" class="headerlink" title="覆盖默认的PasswordEncoder"></a>覆盖默认的PasswordEncoder</h2><p><code>Spring Security 5.x</code>版本默认的<code>PasswordEncoder</code>方式改成了<code>DelegatingPasswordEncoder</code>委托类，不过如果是通过<code>PasswordEncoderFactories#createDelegatingPasswordEncoder</code>方法创建的<code>DelegatingPasswordEncoder</code>实例时，默认其实使用的还是<code>BCryptPasswordEncoder</code>，源码如下所示：</p>
<figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> PasswordEncoder <span class="hljs-title">createDelegatingPasswordEncoder</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">  String encodingId = <span class="hljs-string">"bcrypt"</span>;</span><br><span class="line">  Map&lt;String, PasswordEncoder&gt; encoders = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">  encoders.put(encodingId, <span class="hljs-keyword">new</span> BCryptPasswordEncoder());</span><br><span class="line">  <span class="hljs-comment">// 省略...</span></span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> DelegatingPasswordEncoder(encodingId, encoders);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果我们项目中不需要使用<code>DelegatingPasswordEncoder</code>委托密码编码方式，可以通过<code>@Bean</code>的方式来统一配置全局共用的<code>PasswordEncoder</code>，如下所示：</p>
<figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">@Bean</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">public</span> PasswordEncoder <span class="hljs-title">passwordEncoder</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> BCryptPasswordEncoder();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>可以根据项目自行选择所使用的<code>PasswordEncoder</code>实现类。</p>
</blockquote>

        
        <!--原创-->
        
        <!--转载标注-->
        
        
      </div>
      <!--文章标签-->
      
      
      
    </div>
  </div>

  
  

  
  <!--评论-->
  
  
</div>

<script src="/js/readmore.js" type="text/javascript"></script>
<script>
  const btw = new BTWPlugin();
  btw.init({
    id: 'container',
    blogId: '10034-1569731208928-426',
    name: '恒宇少年',
    qrcode: 'https://blog.yuqiyu.com/images/mp.jpg',
    keyword: 'free',
  });
</script>

<!--<script src="/js/layui.js"></script>
<script>
  layui.use(['layer'], function () {
    var layer = layui.layer;
    var isShowOnce = localStorage.getItem('isShowHistory');
    if (!isShowOnce) {
      localStorage.setItem('isShowHistory',true);
      layer.open({
          type: 1
          ,title: false //不显示标题栏
          ,closeBtn: false
          ,area: '350px;'
          ,shade: 0.8
          ,id: 'LAY_layuipro' //设定一个id，防止重复弹出
          ,btn: ['带朕去看看', '给朕退下']
          ,btnAlign: 'c'
          ,moveType: 1 //拖拽模式，0或者1
          ,content: '<div style="padding: 50px; line-height: 22px; background-color: #393D49; color: #fff; font-size:13px; font-weight: 300;">你知道吗？阿里云的采购季来了！！！<br/><br/>云产品低至<b>0.75折</b> </br></br>ECS服务器最低 <b>¥74.43</b>/年 ...<br><br>MySQL云数据库最低 <b>¥188</b>/年 ...<br><br>1.5万条的短信只需要 <b>¥540</b> <br/><br/>500G的CDN流量包更是优惠到极致了...</div>'
          ,success: function(layero){
            var btn = layero.find('.layui-layer-btn');
            btn.find('.layui-layer-btn0').attr({
              href: 'https://www.aliyun.com/minisite/goods?userCode=rqxni4zt&share_source=copy_link'
              ,target: '_blank'
            });
          }
        });
    }
  });
</script>-->


    
<div id="container">
  
  <div class="card" style="margin-bottom: 10px">
    
    <div class="card-content article ">
      <!--文章标题-->
      
      <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
        
        <a class="has-link-black-ter" href="/spring-boot-basic-use-commandlinerunner-or-applicationrunner.html">SpringBoot2.x基础篇：使用CommandLineRunner或ApplicationRunner</a>
        
      </h1>
      <!--完全自定义页面显示的访问次数-->
      
      
      <div class="level article-meta is-mobile is-overflow-x-auto" style="font-size: 15px">
        <div class="level-left">
          <!--文章类型-->
          
          
          
          <span
            style="float: left;padding: 1px 2px 1px 2px;margin-right: 5px;background-color: #5cb85c;color: white;text-align: center;border-radius:0.25em;font-size: 14px">
            原创</span>
          
          
          &nbsp;&nbsp;&nbsp;&nbsp;
          <!--发布时间-->
          <img src="/images/date_time.png" style="width: 25px;" title="发布时间"/>
          &nbsp;
          <span class="article-meta-element">2020-07-03</span>
          &nbsp;&nbsp;&nbsp;&nbsp;
          <!--作者-->
          <img src="/images/author.svg" style="width: 23px" title="文章作者"/>

          <span class="article-meta-element">于起宇</span>
          &nbsp;&nbsp;&nbsp;&nbsp;
          <!--目录列表-->
          
          <img src="/images/categories.svg" style="width: 20px;" title="文章所属目录列表"/>
          &nbsp;
          <div class="level-item article-meta-element">
            <!--读取config.yml文件内的目录配置-->
            
            
              
                
                  <!--跳转文章目录地址-->
                  <a class="category-link" href="/spring-boot-all-articles.html">SpringBoot</a>&nbsp;
                
              
                
              
                
              
                
              
            
          </div>
          
          <!--不蒜子统计阅读量-->
          <!---->
        </div>
      </div>
      
      
      <!--推荐阅读 - 新闻-->
      
      <!--文章内容-->
      <div class="content">
        <p>如果你想要使用<code>SpringBoot</code>构建的项目在启动后运行一些特定的代码，那么<code>CommandLineRunner</code>、<code>ApplicationRunner</code>都是很好的选择。</p>
<h2 id="推荐阅读"><a href="#推荐阅读" class="headerlink" title="推荐阅读"></a>推荐阅读</h2><ul>
<li><a href="http://blog.yuqiyu.com/spring-boot-2-x-articles.html" target="_blank" rel="noopener">SpringBoot2.x 教程汇总</a></li>
</ul>
<h2 id="使用方式"><a href="#使用方式" class="headerlink" title="使用方式"></a>使用方式</h2><p>我们以<code>CommandLineRunner</code>创建了一个简单的例子，如下所示：</p>
<figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment"> * &#123;<span class="hljs-doctag">@link</span> CommandLineRunner&#125;接口使用示例</span></span><br><span class="line"><span class="hljs-comment"> *</span></span><br><span class="line"><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 恒宇少年</span></span><br><span class="line"><span class="hljs-comment"> */</span></span><br><span class="line"><span class="hljs-meta">@Component</span></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CommandLineRunnerExample</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">CommandLineRunner</span> </span>&#123;</span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * 实例化本类的日志采集器</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-keyword">static</span> LoggingCollector logging = LoggingCollectorFactory.getCollector(CommandLineRunnerExample<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-meta">@Override</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">(String... args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="hljs-comment">// 执行特定的代码</span></span><br><span class="line">        logging.debug(<span class="hljs-string">"main方法参数列表：&#123;&#125;"</span>, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>CommandLineRunner</code>接口的定义很简单，只提供了一个名为<code>#run()</code>的方法，我们只需要实现该方法做一些自定义的业务逻辑即可，<code>ApplicationRunner</code>接口的使用方式也是一样的。</p>
<h2 id="两者的区别？"><a href="#两者的区别？" class="headerlink" title="两者的区别？"></a>两者的区别？</h2><p>从源码上分析，<code>CommandLineRunner</code>与<code>ApplicationRunner</code>两者之间只有<code>#run()</code>方法的参数不一样而已。</p>
<p><strong>CommandLineRunner：</strong></p>
<figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">@FunctionalInterface</span></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">CommandLineRunner</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">	 * Callback used to run the bean.</span></span><br><span class="line"><span class="hljs-comment">	 * <span class="hljs-doctag">@param</span> args incoming main method arguments</span></span><br><span class="line"><span class="hljs-comment">	 * <span class="hljs-doctag">@throws</span> Exception on error</span></span><br><span class="line"><span class="hljs-comment">	 */</span></span><br><span class="line">	<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">(String... args)</span> <span class="hljs-keyword">throws</span> Exception</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>ApplicationRunner：</strong></p>
<figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">@FunctionalInterface</span></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">ApplicationRunner</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">	 * Callback used to run the bean.</span></span><br><span class="line"><span class="hljs-comment">	 * <span class="hljs-doctag">@param</span> args incoming application arguments</span></span><br><span class="line"><span class="hljs-comment">	 * <span class="hljs-doctag">@throws</span> Exception on error</span></span><br><span class="line"><span class="hljs-comment">	 */</span></span><br><span class="line">	<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">(ApplicationArguments args)</span> <span class="hljs-keyword">throws</span> Exception</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>CommandLineRunner#run()</code>方法的参数是启动<code>SpringBoot</code>应用程序<code>main</code>方法的参数列表，而<code>ApplicationRunner#run()</code>方法的参数则是<code>ApplicationArguments</code>对象。</p>
<p>在之前的文章中也提到过<code>ApplicatgionArguments</code>对象，并使用它获取外部的配置参数，查看：<a href="https://blog.yuqiyu.com/spring-boot-basic-accessing-application-arguments.html" target="_blank" rel="noopener">应用程序在启动时访问启动项参数</a>。</p>
<blockquote>
<p><strong>建议：</strong>如果你在项目启动时需要获取类似 “–xxx” 的启动参数值建议使用<code>ApplicationRunner</code></p>
</blockquote>
<h2 id="什么时候会被调用？"><a href="#什么时候会被调用？" class="headerlink" title="什么时候会被调用？"></a>什么时候会被调用？</h2><p>我们已经了解<code>CommandLineRunner</code>与<code>ApplicationRunner</code>两个接口的使用以及区别，是不是很想知道<code>SpringBoot</code>在启动时在什么时候调用它们的呢？</p>
<p>我们大家都知道<code>SpringBoot</code>应用程序的启动主要归功于<code>SpringApplication</code>这个类，我们在创建项目时在启动类内会调用<code>SpringApplication#run()</code>方法，如下所示：</p>
<figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;</span><br><span class="line">  SpringApplication.run(LoggingServiceApplication<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">args</span>)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>那我们来查看下<code>SpringApplication</code>类<code>#run()</code>方法的源码，根据查看方法之间的相互调用，最终我们会定位到<code>org.springframework.boot.SpringApplication#run(java.lang.String...)</code>这个方法，阅读该方法时发现有关调用<code>Runner</code>的定义，如下所示：</p>
<figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">// 省略部分源码</span></span><br><span class="line">listeners.started(context);</span><br><span class="line">callRunners(context, applicationArguments);</span><br><span class="line"><span class="hljs-comment">// 省略部分源码</span></span><br></pre></td></tr></table></figure>

<p><code>#callRunnners()</code>方法的调用确实是在应用程序启动完成后，而且把<code>ApplicationContext</code>与<code>ApplicationArguments</code>对象都作为参数进行了传递，那么我们来看看这个方法究竟干了些什么事情？</p>
<p><strong>SpringApplication#callRunners：</strong></p>
<figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">callRunners</span><span class="hljs-params">(ApplicationContext context, ApplicationArguments args)</span> </span>&#123;</span><br><span class="line">  List&lt;Object&gt; runners = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">  runners.addAll(context.getBeansOfType(ApplicationRunner<span class="hljs-class">.<span class="hljs-keyword">class</span>).<span class="hljs-title">values</span>())</span>;</span><br><span class="line">  runners.addAll(context.getBeansOfType(CommandLineRunner<span class="hljs-class">.<span class="hljs-keyword">class</span>).<span class="hljs-title">values</span>())</span>;</span><br><span class="line">  AnnotationAwareOrderComparator.sort(runners);</span><br><span class="line">  <span class="hljs-keyword">for</span> (Object runner : <span class="hljs-keyword">new</span> LinkedHashSet&lt;&gt;(runners)) &#123;</span><br><span class="line">    <span class="hljs-keyword">if</span> (runner <span class="hljs-keyword">instanceof</span> ApplicationRunner) &#123;</span><br><span class="line">      callRunner((ApplicationRunner) runner, args);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="hljs-keyword">if</span> (runner <span class="hljs-keyword">instanceof</span> CommandLineRunner) &#123;</span><br><span class="line">      callRunner((CommandLineRunner) runner, args);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我想大家看到这里就应该明白了，这个方法就是在执行<code>CommandLineRunner</code>以及<code>ApplicationRunner</code>实现类实例的<code>#run()</code>方法，首先会从<code>ApplicationContext</code>中获取<code>CommandLineRunner</code>、<code>ApplicationRunner</code>接口实现类的实例，然后根据不同类型的<code>Runner</code>实例去调用了<code>callRunner</code>方法。</p>
<p><strong>SpringApplication#callRunner：</strong></p>
<figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="hljs-comment">// 调用ApplicationRunner实现类实例#run()</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">callRunner</span><span class="hljs-params">(ApplicationRunner runner, ApplicationArguments args)</span> </span>&#123;</span><br><span class="line">  <span class="hljs-keyword">try</span> &#123;</span><br><span class="line">    (runner).run(args);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="hljs-keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalStateException(<span class="hljs-string">"Failed to execute ApplicationRunner"</span>, ex);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="hljs-comment">// 调用CommandLineRunner实现类实例#run()</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">callRunner</span><span class="hljs-params">(CommandLineRunner runner, ApplicationArguments args)</span> </span>&#123;</span><br><span class="line">  <span class="hljs-keyword">try</span> &#123;</span><br><span class="line">    (runner).run(args.getSourceArgs());</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="hljs-keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalStateException(<span class="hljs-string">"Failed to execute CommandLineRunner"</span>, ex);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="设置执行顺序"><a href="#设置执行顺序" class="headerlink" title="设置执行顺序"></a>设置执行顺序</h2><p>那如果我们创建了多个<code>CommandLineRunner</code>、<code>ApplicationRunner</code>实现类，还想要实现类在执行的时候有一定的先后顺序，那你不妨试下<code>org.springframework.core.annotation.Order</code>这个注解或者实现<code>org.springframework.core.Ordered</code>接口。</p>
<p><strong>CommandLineRunnerExample：</strong></p>
<figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment"> * &#123;<span class="hljs-doctag">@link</span> CommandLineRunner&#125;接口使用示例</span></span><br><span class="line"><span class="hljs-comment"> *</span></span><br><span class="line"><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 恒宇少年</span></span><br><span class="line"><span class="hljs-comment"> */</span></span><br><span class="line"><span class="hljs-meta">@Component</span></span><br><span class="line"><span class="hljs-meta">@Order</span>(<span class="hljs-number">100</span>)</span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CommandLineRunnerExample</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">CommandLineRunner</span>, <span class="hljs-title">Ordered</span> </span>&#123;</span><br><span class="line">    <span class="hljs-comment">// 省略部分代码</span></span><br><span class="line">    <span class="hljs-meta">@Override</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">getOrder</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-number">100</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>接口</strong>与<strong>注解</strong>的方式选择其中一种就可以了。</p>
</blockquote>

        
        <!--原创-->
        
        <!--转载标注-->
        
        
      </div>
      <!--文章标签-->
      
      
      
    </div>
  </div>

  
  

  
  <!--评论-->
  
  
</div>

<script src="/js/readmore.js" type="text/javascript"></script>
<script>
  const btw = new BTWPlugin();
  btw.init({
    id: 'container',
    blogId: '10034-1569731208928-426',
    name: '恒宇少年',
    qrcode: 'https://blog.yuqiyu.com/images/mp.jpg',
    keyword: 'free',
  });
</script>

<!--<script src="/js/layui.js"></script>
<script>
  layui.use(['layer'], function () {
    var layer = layui.layer;
    var isShowOnce = localStorage.getItem('isShowHistory');
    if (!isShowOnce) {
      localStorage.setItem('isShowHistory',true);
      layer.open({
          type: 1
          ,title: false //不显示标题栏
          ,closeBtn: false
          ,area: '350px;'
          ,shade: 0.8
          ,id: 'LAY_layuipro' //设定一个id，防止重复弹出
          ,btn: ['带朕去看看', '给朕退下']
          ,btnAlign: 'c'
          ,moveType: 1 //拖拽模式，0或者1
          ,content: '<div style="padding: 50px; line-height: 22px; background-color: #393D49; color: #fff; font-size:13px; font-weight: 300;">你知道吗？阿里云的采购季来了！！！<br/><br/>云产品低至<b>0.75折</b> </br></br>ECS服务器最低 <b>¥74.43</b>/年 ...<br><br>MySQL云数据库最低 <b>¥188</b>/年 ...<br><br>1.5万条的短信只需要 <b>¥540</b> <br/><br/>500G的CDN流量包更是优惠到极致了...</div>'
          ,success: function(layero){
            var btn = layero.find('.layui-layer-btn');
            btn.find('.layui-layer-btn0').attr({
              href: 'https://www.aliyun.com/minisite/goods?userCode=rqxni4zt&share_source=copy_link'
              ,target: '_blank'
            });
          }
        });
    }
  });
</script>-->


    
<div id="container">
  
  <div class="card" style="margin-bottom: 10px">
    
    <div class="card-content article ">
      <!--文章标题-->
      
      <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
        
        <a class="has-link-black-ter" href="/spring-boot-basic-packaging-webjars.html">SpringBoot2.x基础篇：将静态资源打包为WebJars</a>
        
      </h1>
      <!--完全自定义页面显示的访问次数-->
      
      
      <div class="level article-meta is-mobile is-overflow-x-auto" style="font-size: 15px">
        <div class="level-left">
          <!--文章类型-->
          
          
          
          <span
            style="float: left;padding: 1px 2px 1px 2px;margin-right: 5px;background-color: #5cb85c;color: white;text-align: center;border-radius:0.25em;font-size: 14px">
            原创</span>
          
          
          &nbsp;&nbsp;&nbsp;&nbsp;
          <!--发布时间-->
          <img src="/images/date_time.png" style="width: 25px;" title="发布时间"/>
          &nbsp;
          <span class="article-meta-element">2020-04-15</span>
          &nbsp;&nbsp;&nbsp;&nbsp;
          <!--作者-->
          <img src="/images/author.svg" style="width: 23px" title="文章作者"/>

          <span class="article-meta-element">于起宇</span>
          &nbsp;&nbsp;&nbsp;&nbsp;
          <!--目录列表-->
          
          <img src="/images/categories.svg" style="width: 20px;" title="文章所属目录列表"/>
          &nbsp;
          <div class="level-item article-meta-element">
            <!--读取config.yml文件内的目录配置-->
            
            
              
                
                  <!--跳转文章目录地址-->
                  <a class="category-link" href="/spring-boot-all-articles.html">SpringBoot</a>&nbsp;
                
              
                
              
                
              
                
              
            
          </div>
          
          <!--不蒜子统计阅读量-->
          <!---->
        </div>
      </div>
      
      
      <!--推荐阅读 - 新闻-->
      
      <!--文章内容-->
      <div class="content">
        <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>我们在编写前后分离项目时，前端的项目一般需要静态资源（<code>Image</code>、<code>CSS</code>、<code>JavaScript</code>…）来进行渲染界面，而如果我们对外采用依赖的方式提供使用时，我们的静态资源文件也应该放入打包文件内，这样才能更便捷的提供我们的功能，在我的开源分布式日志框架 <a href="https://gitee.com/minbox-projects/minbox-logging" target="_blank" rel="noopener">minbox-logging</a> 内提供了管理界面的功能，就是采用的这种方式实现，将静态资源以及<strong>编译后</strong>的<code>HTML</code>页面存放到<code>minbox-logging-admin-ui</code>依赖内，下面我们来看下具体的实现方式。</p>
<h2 id="推荐阅读"><a href="#推荐阅读" class="headerlink" title="推荐阅读"></a>推荐阅读</h2><ul>
<li><a href="http://blog.yuqiyu.com/spring-boot-2-x-articles.html" target="_blank" rel="noopener">SpringBoot2.x 教程汇总</a></li>
</ul>
<h2 id="了解Resources-Static-Locations"><a href="#了解Resources-Static-Locations" class="headerlink" title="了解Resources Static Locations"></a>了解Resources Static Locations</h2><p>在我们打包静态资源前，首先来了解下<code>SpringBoot</code>提供的<code>spring.resources.static-locations</code>配置默认值，该配置用于配置<code>ResourceHandler</code>，项目启动后会将该参数的<code>配置值列表</code>作为<strong>直接可访问</strong>的静态目录进行<code>映射</code>，通过这种方式我们就可以直接访问到我们需要的静态资源内容。</p>
<p><code>spring.resources.static-locations</code>配置位于<code>org.springframework.boot.autoconfigure.web.ResourceProperties</code>配置类内，其默认值是使用本类内的静态常量<code>CLASSPATH_RESOURCE_LOCATIONS</code>的值，如下所示：</p>
<figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String[] CLASSPATH_RESOURCE_LOCATIONS = &#123; <span class="hljs-string">"classpath:/META-INF/resources/"</span>,</span><br><span class="line">                                                              <span class="hljs-string">"classpath:/resources/"</span>, <span class="hljs-string">"classpath:/static/"</span>, <span class="hljs-string">"classpath:/public/"</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">	 * Locations of static resources. Defaults to classpath:[/META-INF/resources/,</span></span><br><span class="line"><span class="hljs-comment">	 * /resources/, /static/, /public/].</span></span><br><span class="line"><span class="hljs-comment">	 */</span></span><br><span class="line"><span class="hljs-keyword">private</span> String[] staticLocations = CLASSPATH_RESOURCE_LOCATIONS;</span><br></pre></td></tr></table></figure>

<p>通过查看源码我们得知，<code>classpath:/META-INF/resources/</code>目录下的资源是可以直接通过默认的映射绑定关系访问到的，通过这一点，我们可以将静态资源依赖内的资源文件存放到<code>META-INF/resources</code>目录下。</p>
<h2 id="资源打包"><a href="#资源打包" class="headerlink" title="资源打包"></a>资源打包</h2><p>我们使用<code>Maven</code>方式构建一个普通的项目，在<code>pom.xml</code>文件内添加<code>资源目录</code>配置，在<code>编译</code>过程中将<code>src/main/resources</code>目录下的文件全部复制到<code>META-INF/resources</code>下，如下所示：</p>
<figure class="highlight xml hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">resources</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">resource</span>&gt;</span></span><br><span class="line">      <span class="hljs-tag">&lt;<span class="hljs-name">directory</span>&gt;</span>src/main/resources<span class="hljs-tag">&lt;/<span class="hljs-name">directory</span>&gt;</span></span><br><span class="line">      <span class="hljs-tag">&lt;<span class="hljs-name">targetPath</span>&gt;</span>META-INF/resources<span class="hljs-tag">&lt;/<span class="hljs-name">targetPath</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;/<span class="hljs-name">resource</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;/<span class="hljs-name">resources</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>为了验证资源访问，我们在<code>src/main/resources</code>目录下存放一个名为<code>head.jpg</code>的图片。</p>
</blockquote>
<p>我们为了本地演示使用，将<code>Maven</code>项目通过<code>mvn install</code>命令安装到本地仓库，以便于提供给其他项目使用。</p>
<h2 id="使用WebJars依赖"><a href="#使用WebJars依赖" class="headerlink" title="使用WebJars依赖"></a>使用WebJars依赖</h2><p>我们来创建一个<code>SpringBoot</code>项目，在项目的<code>pom.xml</code>文件内添加如下依赖：</p>
<figure class="highlight xml hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span></span><br><span class="line">  <span class="hljs-comment">&lt;!--静态资源的访问映射绑定需要web依赖--&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.example<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>webjars-sample<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>由于我们在之前通过<code>mvn install</code>命令将<code>静态资源项目</code>安装到了本地仓库，所以我们可以使用依赖。</p>
<p>通过<code>IDEA</code>工具我们可以查看<code>webjars-sample</code>依赖内的资源文件，如下图所示：</p>
<p><img src="https://blog.yuqiyu.com/images/post/spring-boot-basic-packaging-webjars-1.png" alt></p>
<p>由于<code>SpringBoot</code>提供的<code>spring.resources.static-locations</code>参数默认值，会将<code>classpath:/META-INF/resources</code>目录作为静态资源映射，所以我们可以直接进行访问<code>head.jpg</code>文件。</p>
<p>运行<code>SpringBoot</code>项目，通过访问 <a href="http://localhost:8080/head.jpg" target="_blank" rel="noopener">http://localhost:8080/head.jpg</a>，效果如下图：</p>
<p><img src="https://blog.yuqiyu.com/images/post/spring-boot-basic-packaging-webjars-2.png" alt></p>
<h2 id="静态资源访问前缀"><a href="#静态资源访问前缀" class="headerlink" title="静态资源访问前缀"></a>静态资源访问前缀</h2><p>我们在访问静态资源的时候并没有直接加前缀，而是通过<code>ip:port/head.jpg</code>直接访问，这主要是<code>SpringBoot</code>还提供了另外一个配置<code>spring.mvc.static-path-pattern</code>，其作用是用来配置<code>静态资源的访问前缀</code>，默认值为<code>/**</code>，如果需要修改直接在<code>application.yml</code>文件内进行赋值即可，</p>
<p><strong>application.yml</strong>配置文件，如下所示：</p>
<figure class="highlight yaml hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-attr">spring:</span></span><br><span class="line">  <span class="hljs-attr">application:</span></span><br><span class="line">    <span class="hljs-attr">name:</span> <span class="hljs-string">example</span></span><br><span class="line">  <span class="hljs-attr">mvc:</span></span><br><span class="line">    <span class="hljs-attr">static-path-pattern:</span> <span class="hljs-string">/static/**</span></span><br></pre></td></tr></table></figure>

<p>我们修改了<code>spring.mvc.static-path-pattern</code>配置的值为<code>/static/**</code>，当我们重启项目后需要通过  <a href="http://localhost:8080/static/head.jpg" target="_blank" rel="noopener">http://localhost:8080/static/head.jpg</a> 才可以访问到资源。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>如果你有一些资源不希望被别人修改，让使用者更加便利的集成时，可以采用这种方式来封装自己的<code>webjars</code>，只需要添加依赖引用就可以访问到静态资源，也可以将静态<code>HTML</code>网页通过这种方式打包。</p>

        
        <!--原创-->
        
        <!--转载标注-->
        
        
      </div>
      <!--文章标签-->
      
      
      
    </div>
  </div>

  
  

  
  <!--评论-->
  
  
</div>

<script src="/js/readmore.js" type="text/javascript"></script>
<script>
  const btw = new BTWPlugin();
  btw.init({
    id: 'container',
    blogId: '10034-1569731208928-426',
    name: '恒宇少年',
    qrcode: 'https://blog.yuqiyu.com/images/mp.jpg',
    keyword: 'free',
  });
</script>

<!--<script src="/js/layui.js"></script>
<script>
  layui.use(['layer'], function () {
    var layer = layui.layer;
    var isShowOnce = localStorage.getItem('isShowHistory');
    if (!isShowOnce) {
      localStorage.setItem('isShowHistory',true);
      layer.open({
          type: 1
          ,title: false //不显示标题栏
          ,closeBtn: false
          ,area: '350px;'
          ,shade: 0.8
          ,id: 'LAY_layuipro' //设定一个id，防止重复弹出
          ,btn: ['带朕去看看', '给朕退下']
          ,btnAlign: 'c'
          ,moveType: 1 //拖拽模式，0或者1
          ,content: '<div style="padding: 50px; line-height: 22px; background-color: #393D49; color: #fff; font-size:13px; font-weight: 300;">你知道吗？阿里云的采购季来了！！！<br/><br/>云产品低至<b>0.75折</b> </br></br>ECS服务器最低 <b>¥74.43</b>/年 ...<br><br>MySQL云数据库最低 <b>¥188</b>/年 ...<br><br>1.5万条的短信只需要 <b>¥540</b> <br/><br/>500G的CDN流量包更是优惠到极致了...</div>'
          ,success: function(layero){
            var btn = layero.find('.layui-layer-btn');
            btn.find('.layui-layer-btn0').attr({
              href: 'https://www.aliyun.com/minisite/goods?userCode=rqxni4zt&share_source=copy_link'
              ,target: '_blank'
            });
          }
        });
    }
  });
</script>-->


    
<div id="container">
  
  <div class="card" style="margin-bottom: 10px">
    
    <div class="card-content article ">
      <!--文章标题-->
      
      <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
        
        <a class="has-link-black-ter" href="/spring-boot-basic-configure-binding-away.html">SpringBoot2.x基础篇：谈谈SpringBoot内提供的这几种配置绑定</a>
        
      </h1>
      <!--完全自定义页面显示的访问次数-->
      
      
      <div class="level article-meta is-mobile is-overflow-x-auto" style="font-size: 15px">
        <div class="level-left">
          <!--文章类型-->
          
          
          
          <span
            style="float: left;padding: 1px 2px 1px 2px;margin-right: 5px;background-color: #5cb85c;color: white;text-align: center;border-radius:0.25em;font-size: 14px">
            原创</span>
          
          
          &nbsp;&nbsp;&nbsp;&nbsp;
          <!--发布时间-->
          <img src="/images/date_time.png" style="width: 25px;" title="发布时间"/>
          &nbsp;
          <span class="article-meta-element">2020-04-06</span>
          &nbsp;&nbsp;&nbsp;&nbsp;
          <!--作者-->
          <img src="/images/author.svg" style="width: 23px" title="文章作者"/>

          <span class="article-meta-element">于起宇</span>
          &nbsp;&nbsp;&nbsp;&nbsp;
          <!--目录列表-->
          
          <img src="/images/categories.svg" style="width: 20px;" title="文章所属目录列表"/>
          &nbsp;
          <div class="level-item article-meta-element">
            <!--读取config.yml文件内的目录配置-->
            
            
              
                
                  <!--跳转文章目录地址-->
                  <a class="category-link" href="/spring-boot-all-articles.html">SpringBoot</a>&nbsp;
                
              
                
              
                
              
                
              
            
          </div>
          
          <!--不蒜子统计阅读量-->
          <!---->
        </div>
      </div>
      
      
      <!--推荐阅读 - 新闻-->
      
      <!--文章内容-->
      <div class="content">
        <h2 id="常见配置绑定方式"><a href="#常见配置绑定方式" class="headerlink" title="常见配置绑定方式"></a>常见配置绑定方式</h2><p><img src="https://blog.yuqiyu.com/images/post/spring-boot-basic-configure-binding-away-1.png" alt></p>
<p><code>SpringBoot</code>在不断地版本迭代中陆续提供了不同的配置参数绑定的方式，我们可以单独获取<code>一个配置参数</code>也可以将<code>一系列的配置</code>映射绑定到<code>JavaBean</code>的属性字段，下面我们来看看这几种方式的配置绑定哪一种是你最常用到的。</p>
<h2 id="示例配置参数"><a href="#示例配置参数" class="headerlink" title="示例配置参数"></a>示例配置参数</h2><figure class="highlight yaml hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-attr">system:</span></span><br><span class="line">  <span class="hljs-attr">config:</span></span><br><span class="line">    <span class="hljs-attr">app-id:</span> <span class="hljs-string">hengboy</span></span><br><span class="line">    <span class="hljs-attr">app-secret:</span> <span class="hljs-string">yuqiyu@admin</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>上面是一段示例的配置参数，提供给下面的配置绑定方式来使用。</p>
</blockquote>
<h2 id="Configuration方式绑定"><a href="#Configuration方式绑定" class="headerlink" title="@Configuration方式绑定"></a>@Configuration方式绑定</h2><p>当我们需要将一个配置前缀下的参数映射绑定到<code>JavaBean</code>的属性字段时，我们可以考虑使用<code>@ConfigurationProperties</code> + <code>@Configuration</code>注解组合的方式，使用如下所示：</p>
<figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment"> * 系统配置</span></span><br><span class="line"><span class="hljs-comment"> *</span></span><br><span class="line"><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 恒宇少年</span></span><br><span class="line"><span class="hljs-comment"> */</span></span><br><span class="line"><span class="hljs-meta">@Configuration</span></span><br><span class="line"><span class="hljs-meta">@ConfigurationProperties</span>(prefix = SYSTEM_CONFIG_PREFIX)</span><br><span class="line"><span class="hljs-meta">@Data</span></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SystemConfig</span> </span>&#123;</span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * 系统配置前缀</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String SYSTEM_CONFIG_PREFIX = <span class="hljs-string">"system.config"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">private</span> String appId;</span><br><span class="line">    <span class="hljs-keyword">private</span> String appSecret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>注意事项：</strong>配置参数与<code>JavaBean</code>属性之间的绑定是通过调用<code>JavaBean</code>属性的<code>Setter</code>方法来赋值的，所以我们需要提供对应属性字段的<code>Setter</code>方法。</p>
</blockquote>
<p>由于<code>@Configuration</code>注解被<code>@Component</code>修饰，所以我们在使用时只需要注入<code>SystemConfig</code>配置绑定映射类即可，通过<code>Getter</code>方法来获取对应配置参数的值。</p>
<h2 id="配置扫描路径方式绑定"><a href="#配置扫描路径方式绑定" class="headerlink" title="配置扫描路径方式绑定"></a>配置扫描路径方式绑定</h2><p>如果你系统中需要创建的配置映射类较多，而且每一个类都需要交付给<code>IOC</code>容器进行托管，那么可以考虑使用<code>@ConfigurationPropertiesScan</code> + <code>@ConfigurationProperties</code>注解组合的方式，使用如下所示：</p>
<figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">@SpringBootApplication</span></span><br><span class="line"><span class="hljs-meta">@ConfigurationPropertiesScan</span></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ConfigureBindingAwayApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(ConfigureBindingAwayApplication<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们首先需要在<code>XxxApplication</code>应用程序启动类上添加<code>@ConfigurationPropertiesScan</code>注解，表示我们需要使用<strong>自动扫描</strong>的方式来注册<code>配置映射类</code>，注解配置参数如下所示：</p>
<ul>
<li><strong>value</strong>：配置扫描的基础<code>package</code>，与<code>basePackages</code>作用一致，通过数组的形式来接收配置。</li>
<li><strong>basePackages</strong>：配置扫描的基础<code>package</code>。</li>
<li><strong>basePackageClasses</strong>：配置基础扫描类，会将每一个扫描类所处于的<code>package</code>作为扫描基础<code>package</code>。</li>
</ul>
<blockquote>
<p>当我们在使用<code>@ConfigurationPropertiesScan</code>注解时，如果不进行自定义扫描路径，默认使用<code>SpringBoot</code>应用程序扫描的<code>packages</code>。</p>
</blockquote>
<p>使用这种方式我们<code>配置映射类</code>就不再需要添加<code>@Configuration</code>注解了，这是因为我们在使用<code>@ConfigurationPropertiesScan</code>注解时，会通过<code>@Import</code>方式来引用<code>配置映射类</code>的注册实现，详见：<code>org.springframework.boot.context.properties.ConfigurationPropertiesScanRegistrar#registerBeanDefinitions</code>，配置映射类如下所示：</p>
<figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment"> * 系统配置</span></span><br><span class="line"><span class="hljs-comment"> *</span></span><br><span class="line"><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 恒宇少年</span></span><br><span class="line"><span class="hljs-comment"> */</span></span><br><span class="line"><span class="hljs-meta">@ConfigurationProperties</span>(prefix = SYSTEM_CONFIG_PREFIX)</span><br><span class="line"><span class="hljs-meta">@Data</span></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SystemConfig</span> </span>&#123;</span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * 系统配置前缀</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String SYSTEM_CONFIG_PREFIX = <span class="hljs-string">"system.config"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">private</span> String appId;</span><br><span class="line">    <span class="hljs-keyword">private</span> String appSecret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="构造函数方式绑定"><a href="#构造函数方式绑定" class="headerlink" title="构造函数方式绑定"></a>构造函数方式绑定</h2><p>在上面的两种方式都是通过<code>Setter</code>方法来进行映射字段的赋值，而<code>构造函数</code>绑定方式是通过构造函数来进行赋值的，我们只需要在<code>配置映射类</code>上添加<code>@ConstructorBinding</code>注解并提供对应的构造函数即可，使用方式如下所示：</p>
<figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment"> * 系统配置</span></span><br><span class="line"><span class="hljs-comment"> *</span></span><br><span class="line"><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> 恒宇少年</span></span><br><span class="line"><span class="hljs-comment"> */</span></span><br><span class="line"><span class="hljs-meta">@ConfigurationProperties</span>(prefix = SYSTEM_CONFIG_PREFIX)</span><br><span class="line"><span class="hljs-meta">@ConstructorBinding</span></span><br><span class="line"><span class="hljs-meta">@Getter</span></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SystemConfig</span> </span>&#123;</span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * 系统配置前缀</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String SYSTEM_CONFIG_PREFIX = <span class="hljs-string">"system.config"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">SystemConfig</span><span class="hljs-params">(String appId, String appSecret)</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">this</span>.appId = appId;</span><br><span class="line">        <span class="hljs-keyword">this</span>.appSecret = appSecret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">private</span> String appId;</span><br><span class="line">    <span class="hljs-keyword">private</span> String appSecret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在之前我也写过一篇关于构造函数映射配置参数的问题，详情访问：<a href="https://blog.yuqiyu.com/springboot-constructor-binding-properties.html" target="_blank" rel="noopener">@ConstructorBinding注解的使用</a></p>
<h2 id="第三方类绑定"><a href="#第三方类绑定" class="headerlink" title="第三方类绑定"></a>第三方类绑定</h2><p>如果我们需要将配置参数映射绑定到第三方依赖内提供的<code>JavaBean</code>，我们该使用什么方式呢？由于接收参数的类并不是我们自己编写的，所以没有办法对<code>.class</code>文件源码进行修改。</p>
<p>这时我们可以将第三方提供的<code>JavaBean</code>交给<code>IOC容器</code>托管，然后结合<code>@ConfigurationProperties</code>注解来映射绑定配置参数，使用方式如下所示：</p>
<figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">@Bean</span></span><br><span class="line"><span class="hljs-meta">@ConfigurationProperties</span>(prefix = SYSTEM_CONFIG_PREFIX)</span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">public</span> SystemConfig <span class="hljs-title">systemConfig</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">	<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> SystemConfig();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这种方式也需要第三方提供的<code>JavaBean</code>有映射字段的<code>Setter</code>方法，否则无法进行赋值。</p>
</blockquote>
<p>我们知道通过<code>@Bean</code>注解修饰的方法，会将方法的返回值加入到<code>IOC容器</code>内，那我们在使用配置时，直接注入<code>配置映射类</code>就可以了。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>上面这几种配置绑定方式都遵循<code>OOP</code>实现，当然如果你只需要获取一个配置参数，使用<code>@Value</code>也是一个好的选择，没有更好，只有更合适，根据每一种绑定方式的特点合理的选择一个合适业务的方式。</p>

        
        <!--原创-->
        
        <!--转载标注-->
        
        
      </div>
      <!--文章标签-->
      
      
      
    </div>
  </div>

  
  

  
  <!--评论-->
  
  
</div>

<script src="/js/readmore.js" type="text/javascript"></script>
<script>
  const btw = new BTWPlugin();
  btw.init({
    id: 'container',
    blogId: '10034-1569731208928-426',
    name: '恒宇少年',
    qrcode: 'https://blog.yuqiyu.com/images/mp.jpg',
    keyword: 'free',
  });
</script>

<!--<script src="/js/layui.js"></script>
<script>
  layui.use(['layer'], function () {
    var layer = layui.layer;
    var isShowOnce = localStorage.getItem('isShowHistory');
    if (!isShowOnce) {
      localStorage.setItem('isShowHistory',true);
      layer.open({
          type: 1
          ,title: false //不显示标题栏
          ,closeBtn: false
          ,area: '350px;'
          ,shade: 0.8
          ,id: 'LAY_layuipro' //设定一个id，防止重复弹出
          ,btn: ['带朕去看看', '给朕退下']
          ,btnAlign: 'c'
          ,moveType: 1 //拖拽模式，0或者1
          ,content: '<div style="padding: 50px; line-height: 22px; background-color: #393D49; color: #fff; font-size:13px; font-weight: 300;">你知道吗？阿里云的采购季来了！！！<br/><br/>云产品低至<b>0.75折</b> </br></br>ECS服务器最低 <b>¥74.43</b>/年 ...<br><br>MySQL云数据库最低 <b>¥188</b>/年 ...<br><br>1.5万条的短信只需要 <b>¥540</b> <br/><br/>500G的CDN流量包更是优惠到极致了...</div>'
          ,success: function(layero){
            var btn = layero.find('.layui-layer-btn');
            btn.find('.layui-layer-btn0').attr({
              href: 'https://www.aliyun.com/minisite/goods?userCode=rqxni4zt&share_source=copy_link'
              ,target: '_blank'
            });
          }
        });
    }
  });
</script>-->


    
<div id="container">
  
  <div class="card" style="margin-bottom: 10px">
    
    <div class="card-content article ">
      <!--文章标题-->
      
      <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
        
        <a class="has-link-black-ter" href="/spring-boot-basic-using-yaml-instead-of-properties.html">SpringBoot2.x基础篇：使用YAML代替Properties的对应配置</a>
        
      </h1>
      <!--完全自定义页面显示的访问次数-->
      
      
      <div class="level article-meta is-mobile is-overflow-x-auto" style="font-size: 15px">
        <div class="level-left">
          <!--文章类型-->
          
          
          
          <span
            style="float: left;padding: 1px 2px 1px 2px;margin-right: 5px;background-color: #5cb85c;color: white;text-align: center;border-radius:0.25em;font-size: 14px">
            原创</span>
          
          
          &nbsp;&nbsp;&nbsp;&nbsp;
          <!--发布时间-->
          <img src="/images/date_time.png" style="width: 25px;" title="发布时间"/>
          &nbsp;
          <span class="article-meta-element">2020-03-26</span>
          &nbsp;&nbsp;&nbsp;&nbsp;
          <!--作者-->
          <img src="/images/author.svg" style="width: 23px" title="文章作者"/>

          <span class="article-meta-element">于起宇</span>
          &nbsp;&nbsp;&nbsp;&nbsp;
          <!--目录列表-->
          
          <img src="/images/categories.svg" style="width: 20px;" title="文章所属目录列表"/>
          &nbsp;
          <div class="level-item article-meta-element">
            <!--读取config.yml文件内的目录配置-->
            
            
              
                
                  <!--跳转文章目录地址-->
                  <a class="category-link" href="/spring-boot-all-articles.html">SpringBoot</a>&nbsp;
                
              
                
              
                
              
                
              
            
          </div>
          
          <!--不蒜子统计阅读量-->
          <!---->
        </div>
      </div>
      
      
      <!--推荐阅读 - 新闻-->
      
      <!--文章内容-->
      <div class="content">
        <p><code>YAML</code>是一种用于指定层次结构配置数据的便捷格式，<code>SpringBoot</code>内部通过集成<a href="https://bitbucket.org/asomov/snakeyaml" target="_blank" rel="noopener">SnakeYAML</a>来支持解析，那我们如果来使用<code>YAML</code>格式来代替<code>Properties</code>，我们需要了解每一种<code>Properties</code>对应<code>YAML</code>的配置代替方式。</p>
<h2 id="推荐阅读"><a href="#推荐阅读" class="headerlink" title="推荐阅读"></a>推荐阅读</h2><ul>
<li><a href="http://blog.yuqiyu.com/spring-boot-2-x-articles.html" target="_blank" rel="noopener">SpringBoot2.x 教程汇总</a></li>
</ul>
<h2 id="普通配置"><a href="#普通配置" class="headerlink" title="普通配置"></a>普通配置</h2><p>普通的方式比较简单直接，不存在<code>数组</code>、<code>集合</code>、<code>子类</code>等相关配置，我们通过<code>Properties</code>方式编写了如下的配置内容：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">system.config.max-value=100</span><br><span class="line">system.config.min-value=10</span><br><span class="line">system.config.location=classpath:/configs</span><br></pre></td></tr></table></figure>

<p>那这种方式对应的<code>YAML</code>配置是什么样子的呢？</p>
<p>如下所示：</p>
<figure class="highlight yaml hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-attr">system:</span></span><br><span class="line">  <span class="hljs-attr">config:</span></span><br><span class="line">    <span class="hljs-attr">min-value:</span> <span class="hljs-number">10</span></span><br><span class="line">    <span class="hljs-attr">max-value:</span> <span class="hljs-number">100</span></span><br><span class="line">    <span class="hljs-attr">location:</span> <span class="hljs-string">classpath:/configs</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>这两种方式对比之下，<code>YAML</code>层次感鲜明，更直观的查看配置信息，而<code>Properties</code>这种方式配置前缀相对来说是<strong>冗余</strong>的，如果配置前缀过长，每一行的配置内容则会更长。</p>
</blockquote>
<h2 id="List配置"><a href="#List配置" class="headerlink" title="List配置"></a>List配置</h2><p>如果你需要添加<code>List/Set/Array</code>类型的配置信息，使用<code>Properties</code>方式编写如下所示：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">system.config.ports[0]=8080</span><br><span class="line">system.config.ports[1]=8081</span><br><span class="line">system.config.ports[2]=8082</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>注意事项：</strong>配置的索引从<strong>0</strong>开始。</p>
</blockquote>
<p>对应上面配置的<code>YAML</code>实现如下所示：</p>
<figure class="highlight yaml hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-attr">system:</span></span><br><span class="line">  <span class="hljs-attr">config:</span></span><br><span class="line">    <span class="hljs-attr">ports:</span></span><br><span class="line">      <span class="hljs-bullet">-</span> <span class="hljs-number">8080</span></span><br><span class="line">      <span class="hljs-bullet">-</span> <span class="hljs-number">8081</span></span><br><span class="line">      <span class="hljs-bullet">-</span> <span class="hljs-number">8082</span></span><br></pre></td></tr></table></figure>

<p>无论是<code>Properties</code>还是<code>YAML</code>格式，这种<code>List</code>的配置内容都可以通过如下的方式获取：</p>
<figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">@Configuration</span></span><br><span class="line"><span class="hljs-meta">@ConfigurationProperties</span>(prefix = <span class="hljs-string">"system.config"</span>)</span><br><span class="line"><span class="hljs-meta">@Data</span></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LoadListConfig</span> </span>&#123;</span><br><span class="line">    <span class="hljs-keyword">private</span> List&lt;String&gt; ports;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="List内实体配置"><a href="#List内实体配置" class="headerlink" title="List内实体配置"></a>List内实体配置</h2><p>如果你的<code>List</code>内不是基本数据类型，而是一个实体类，使用<code>Properties</code>的配置方式如下所示：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">system.users[0].username=admin</span><br><span class="line">system.users[0].email=yuqiyu@vip.qq.com</span><br><span class="line">system.users[1].username=hengboy</span><br><span class="line">system.users[1].email=jnyuqy@gmail.com</span><br></pre></td></tr></table></figure>

<p>其实跟上面的<code>List配置</code>差不多，不过如果你需要配置每一个索引内字段的值，就要一一指定配置值。</p>
<p>对应上面的<code>YAML</code>实现如下所示：</p>
<figure class="highlight yaml hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-attr">system:</span></span><br><span class="line">  <span class="hljs-attr">users:</span></span><br><span class="line">    <span class="hljs-bullet">-</span> <span class="hljs-attr">username:</span> <span class="hljs-string">admin</span></span><br><span class="line">      <span class="hljs-attr">email:</span> <span class="hljs-string">yuqiyu@vip.qq.com</span></span><br><span class="line">    <span class="hljs-bullet">-</span> <span class="hljs-attr">username:</span> <span class="hljs-string">hengboy</span></span><br><span class="line">      <span class="hljs-attr">email:</span> <span class="hljs-string">jnyuqy@gmail.com</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>每一个 <code>-</code> 其实代表集合内的一个元素。</p>
</blockquote>
<p>获取<code>List实体</code>配置时我们可以通过如下的方式：</p>
<figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">@Data</span></span><br><span class="line"><span class="hljs-meta">@Configuration</span></span><br><span class="line"><span class="hljs-meta">@ConfigurationProperties</span>(prefix = <span class="hljs-string">"system"</span>)</span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LoadSystemUserConfig</span> </span>&#123;</span><br><span class="line">    <span class="hljs-keyword">private</span> List&lt;User&gt; users;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-meta">@Getter</span></span><br><span class="line">    <span class="hljs-meta">@Setter</span></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span> </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">private</span> String username;</span><br><span class="line">        <span class="hljs-keyword">private</span> String email;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="YAML缺点"><a href="#YAML缺点" class="headerlink" title="YAML缺点"></a>YAML缺点</h2><p>一种方案的诞生是为了解决相应的问题，虽然说存在既有道理，但是每一种方案也不是完美的都有自身的缺点。</p>
<p>下面简单说说<code>YAML</code>的缺点：</p>
<ul>
<li>配置时<strong>缩进</strong>要特别注意，如果存在空格缩进对应不齐就会出现问题</li>
<li>在<code>SpringBoot</code>内无法通过<code>@PropertySource</code>注解加载<code>YAML</code>文件。</li>
</ul>

        
        <!--原创-->
        
        <!--转载标注-->
        
        
      </div>
      <!--文章标签-->
      
      
      
    </div>
  </div>

  
  

  
  <!--评论-->
  
  
</div>

<script src="/js/readmore.js" type="text/javascript"></script>
<script>
  const btw = new BTWPlugin();
  btw.init({
    id: 'container',
    blogId: '10034-1569731208928-426',
    name: '恒宇少年',
    qrcode: 'https://blog.yuqiyu.com/images/mp.jpg',
    keyword: 'free',
  });
</script>

<!--<script src="/js/layui.js"></script>
<script>
  layui.use(['layer'], function () {
    var layer = layui.layer;
    var isShowOnce = localStorage.getItem('isShowHistory');
    if (!isShowOnce) {
      localStorage.setItem('isShowHistory',true);
      layer.open({
          type: 1
          ,title: false //不显示标题栏
          ,closeBtn: false
          ,area: '350px;'
          ,shade: 0.8
          ,id: 'LAY_layuipro' //设定一个id，防止重复弹出
          ,btn: ['带朕去看看', '给朕退下']
          ,btnAlign: 'c'
          ,moveType: 1 //拖拽模式，0或者1
          ,content: '<div style="padding: 50px; line-height: 22px; background-color: #393D49; color: #fff; font-size:13px; font-weight: 300;">你知道吗？阿里云的采购季来了！！！<br/><br/>云产品低至<b>0.75折</b> </br></br>ECS服务器最低 <b>¥74.43</b>/年 ...<br><br>MySQL云数据库最低 <b>¥188</b>/年 ...<br><br>1.5万条的短信只需要 <b>¥540</b> <br/><br/>500G的CDN流量包更是优惠到极致了...</div>'
          ,success: function(layero){
            var btn = layero.find('.layui-layer-btn');
            btn.find('.layui-layer-btn0').attr({
              href: 'https://www.aliyun.com/minisite/goods?userCode=rqxni4zt&share_source=copy_link'
              ,target: '_blank'
            });
          }
        });
    }
  });
</script>-->


    
<div id="container">
  
  <div class="card" style="margin-bottom: 10px">
    
    <div class="card-content article ">
      <!--文章标题-->
      
      <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
        
        <a class="has-link-black-ter" href="/spring-boot-basic-placeholders-in-config-file.html">SpringBoot2.x基础篇：配置文件中占位符的使用</a>
        
      </h1>
      <!--完全自定义页面显示的访问次数-->
      
      
      <div class="level article-meta is-mobile is-overflow-x-auto" style="font-size: 15px">
        <div class="level-left">
          <!--文章类型-->
          
          
          
          <span
            style="float: left;padding: 1px 2px 1px 2px;margin-right: 5px;background-color: #5cb85c;color: white;text-align: center;border-radius:0.25em;font-size: 14px">
            原创</span>
          
          
          &nbsp;&nbsp;&nbsp;&nbsp;
          <!--发布时间-->
          <img src="/images/date_time.png" style="width: 25px;" title="发布时间"/>
          &nbsp;
          <span class="article-meta-element">2020-03-23</span>
          &nbsp;&nbsp;&nbsp;&nbsp;
          <!--作者-->
          <img src="/images/author.svg" style="width: 23px" title="文章作者"/>

          <span class="article-meta-element">于起宇</span>
          &nbsp;&nbsp;&nbsp;&nbsp;
          <!--目录列表-->
          
          <img src="/images/categories.svg" style="width: 20px;" title="文章所属目录列表"/>
          &nbsp;
          <div class="level-item article-meta-element">
            <!--读取config.yml文件内的目录配置-->
            
            
              
                
                  <!--跳转文章目录地址-->
                  <a class="category-link" href="/spring-boot-all-articles.html">SpringBoot</a>&nbsp;
                
              
                
              
                
              
                
              
            
          </div>
          
          <!--不蒜子统计阅读量-->
          <!---->
        </div>
      </div>
      
      
      <!--推荐阅读 - 新闻-->
      
      <!--文章内容-->
      <div class="content">
        <h2 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h2><p><code>占位符</code>是一种灵活的配置方式，可以让我们很灵活的使用配置参数，<code>@Value</code>注解的配置也是占位符的一种体现方式，这种方式可以从<code>Environment</code>内获取对应的<code>配置值</code>。</p>
<h2 id="推荐阅读"><a href="#推荐阅读" class="headerlink" title="推荐阅读"></a>推荐阅读</h2><ul>
<li><a href="http://blog.yuqiyu.com/spring-boot-2-x-articles.html" target="_blank" rel="noopener">SpringBoot2.x 教程汇总</a></li>
</ul>
<h2 id="配置方式"><a href="#配置方式" class="headerlink" title="配置方式"></a>配置方式</h2><p>在<code>application.yml/properties</code>配置文件内可以直接使用<code>占位符</code>来进行配置的相互引用，如下所示：</p>
<figure class="highlight yaml hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-attr">system:</span></span><br><span class="line">  <span class="hljs-attr">name:</span> <span class="hljs-string">$&#123;spring.application.name&#125;</span></span><br><span class="line"><span class="hljs-attr">spring:</span></span><br><span class="line">  <span class="hljs-attr">application:</span></span><br><span class="line">    <span class="hljs-attr">name:</span> <span class="hljs-string">project-sample</span></span><br></pre></td></tr></table></figure>

<p>在上面的配置中，<code>name</code>配置直接引用了<code>spring.application.name</code>的配置值，这样我们在系统中通过<code>@Value(&quot;${name}&quot;)</code>或者通过<code>@ConfigurationProperties</code>方式使用时，得到的值都为<code>project-sample</code>。</p>
<figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">// @Value方式</span></span><br><span class="line"><span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;system.name&#125;"</span>)</span><br><span class="line"><span class="hljs-keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// @ConfigurationProperties方式</span></span><br><span class="line"><span class="hljs-meta">@Configuration</span></span><br><span class="line"><span class="hljs-meta">@ConfigurationProperties</span>(prefix = <span class="hljs-string">"system"</span>)</span><br><span class="line"><span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LoadConfig</span> </span>&#123;</span><br><span class="line">  <span class="hljs-keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">  <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getName</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">    <span class="hljs-keyword">return</span> name;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setName</span><span class="hljs-params">(String name)</span> </span>&#123;</span><br><span class="line">    <span class="hljs-keyword">this</span>.name = name;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这样方式<strong>极大地减少了相同的配置</strong>出现，让我们在<code>配置文件</code>中也可以实现类似于<code>常量</code>的定义。</p>
</blockquote>
<h2 id="使用默认值"><a href="#使用默认值" class="headerlink" title="使用默认值"></a>使用默认值</h2><p>当我们使用<code>@Value</code>注解来注入配置参数时，如果所引入的配置为<strong>NULL</strong>，启动项目时会抛出异常，项目无法正常启动，所以我们有必要添加一个默认值，如下所示：</p>
<figure class="highlight yaml hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-attr">system:</span></span><br><span class="line">  <span class="hljs-attr">name:</span> <span class="hljs-string">$&#123;spring.application.name:default&#125;</span></span><br><span class="line"><span class="hljs-comment">#spring:</span></span><br><span class="line"><span class="hljs-comment">#  application:</span></span><br><span class="line"><span class="hljs-comment">#    name: project-sample</span></span><br></pre></td></tr></table></figure>

<p>在上面配置中把<code>spring.application.name</code>注释掉，当我们使用<code>${spring.application.name}</code>占位符时其实并未引用到有效的值，通过<code>${xxx:defaultValue}</code>的形式可以配置默认值，当占位符所引用的配置为<code>NULL</code>时，将会使用默认值（<strong>默认值的类型要对配置匹配</strong>）。</p>
<p>也可以通过<code>@Value(&quot;${system.name:default}&quot;)</code>这种方式配置默认值，不建议使用这种方式，默认值有变动时，我们还要一个一个修改，太麻烦了，不要给自己找事干…</p>
<blockquote>
<p>当然对于配置的注入还是推荐使用<code>@ConfigurationProperties</code>，完全遵循<code>OOP</code>设计方式，在应用程序启动时进行赋值，就算是引用的配置为<code>NULL</code>没有默认值，也不会出现启动异常的问题。</p>
</blockquote>
<h2 id="“短”命令行参数"><a href="#“短”命令行参数" class="headerlink" title="“短”命令行参数"></a>“短”命令行参数</h2><p>如果你对命令行参数不熟悉，可以访问 <a href="https://blog.yuqiyu.com/spring-boot-basic-externalized-configuration.html" target="_blank" rel="noopener">SpringBoot2.x基础篇：灵活的使用外部化配置信息</a> 学习。</p>
<p>在实际部署应用程序时，有很多的配置是动态的，<code>命令行</code>参数是一个不错的方式，不过<code>SpringBoot</code>所提供的配置参数名称都比较长，对此我们完全可以利用<code>占位符</code>配置方式实现自定义。</p>
<p><code>占位符</code>是从<code>Environment</code>内读取对应的配置值，而<code>命令行参数</code>在应用程序启动时会被一并加入到<code>Environment</code>中，因此也就实现了<code>占位符</code>动态配置，其实这个“短”的含义，是你定义的新的配置名称比较短而已。</p>
<p>假设我们的端口号需要动态指定，配置文件中可以通过如下的方式配置：</p>
<figure class="highlight yaml hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-attr">server:</span></span><br><span class="line">  <span class="hljs-attr">port:</span> <span class="hljs-string">$&#123;port:8080&#125;</span></span><br></pre></td></tr></table></figure>

<p><code>port</code>是我们定义的“短”<code>占位符</code>，在应用程序启动时并未指定则使用默认值<code>8080</code>。</p>
<figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar project-sample.jar --port=<span class="hljs-number">9090</span></span><br></pre></td></tr></table></figure>

<p>通过<code>--port=9090</code>命令行参数，应用程序启动时端口号就变为了<code>9090</code>。</p>

        
        <!--原创-->
        
        <!--转载标注-->
        
        
      </div>
      <!--文章标签-->
      
      
      
    </div>
  </div>

  
  

  
  <!--评论-->
  
  
</div>

<script src="/js/readmore.js" type="text/javascript"></script>
<script>
  const btw = new BTWPlugin();
  btw.init({
    id: 'container',
    blogId: '10034-1569731208928-426',
    name: '恒宇少年',
    qrcode: 'https://blog.yuqiyu.com/images/mp.jpg',
    keyword: 'free',
  });
</script>

<!--<script src="/js/layui.js"></script>
<script>
  layui.use(['layer'], function () {
    var layer = layui.layer;
    var isShowOnce = localStorage.getItem('isShowHistory');
    if (!isShowOnce) {
      localStorage.setItem('isShowHistory',true);
      layer.open({
          type: 1
          ,title: false //不显示标题栏
          ,closeBtn: false
          ,area: '350px;'
          ,shade: 0.8
          ,id: 'LAY_layuipro' //设定一个id，防止重复弹出
          ,btn: ['带朕去看看', '给朕退下']
          ,btnAlign: 'c'
          ,moveType: 1 //拖拽模式，0或者1
          ,content: '<div style="padding: 50px; line-height: 22px; background-color: #393D49; color: #fff; font-size:13px; font-weight: 300;">你知道吗？阿里云的采购季来了！！！<br/><br/>云产品低至<b>0.75折</b> </br></br>ECS服务器最低 <b>¥74.43</b>/年 ...<br><br>MySQL云数据库最低 <b>¥188</b>/年 ...<br><br>1.5万条的短信只需要 <b>¥540</b> <br/><br/>500G的CDN流量包更是优惠到极致了...</div>'
          ,success: function(layero){
            var btn = layero.find('.layui-layer-btn');
            btn.find('.layui-layer-btn0').attr({
              href: 'https://www.aliyun.com/minisite/goods?userCode=rqxni4zt&share_source=copy_link'
              ,target: '_blank'
            });
          }
        });
    }
  });
</script>-->


    
<div id="container">
  
  <div class="card" style="margin-bottom: 10px">
    
    <div class="card-content article ">
      <!--文章标题-->
      
      <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
        
        <a class="has-link-black-ter" href="/spring-boot-basic-load-order-of-config-files.html">SpringBoot2.x基础篇：配置文件的加载顺序以及优先级覆盖</a>
        
      </h1>
      <!--完全自定义页面显示的访问次数-->
      
      
      <div class="level article-meta is-mobile is-overflow-x-auto" style="font-size: 15px">
        <div class="level-left">
          <!--文章类型-->
          
          
          
          <span
            style="float: left;padding: 1px 2px 1px 2px;margin-right: 5px;background-color: #5cb85c;color: white;text-align: center;border-radius:0.25em;font-size: 14px">
            原创</span>
          
          
          &nbsp;&nbsp;&nbsp;&nbsp;
          <!--发布时间-->
          <img src="/images/date_time.png" style="width: 25px;" title="发布时间"/>
          &nbsp;
          <span class="article-meta-element">2020-03-22</span>
          &nbsp;&nbsp;&nbsp;&nbsp;
          <!--作者-->
          <img src="/images/author.svg" style="width: 23px" title="文章作者"/>

          <span class="article-meta-element">于起宇</span>
          &nbsp;&nbsp;&nbsp;&nbsp;
          <!--目录列表-->
          
          <img src="/images/categories.svg" style="width: 20px;" title="文章所属目录列表"/>
          &nbsp;
          <div class="level-item article-meta-element">
            <!--读取config.yml文件内的目录配置-->
            
            
              
                
                  <!--跳转文章目录地址-->
                  <a class="category-link" href="/spring-boot-all-articles.html">SpringBoot</a>&nbsp;
                
              
                
              
                
              
                
              
            
          </div>
          
          <!--不蒜子统计阅读量-->
          <!---->
        </div>
      </div>
      
      
      <!--推荐阅读 - 新闻-->
      
      <!--文章内容-->
      <div class="content">
        <p><code>SpringBoot</code>约定了配置文件，默认为<code>application.properties</code>，通过该文件可以修改很多默认的配置，当然我们还可以在该配置文件内添加自定义的配置，该文件通过<code>key=value</code>的形式进行配置。</p>
<h2 id="推荐阅读"><a href="#推荐阅读" class="headerlink" title="推荐阅读"></a>推荐阅读</h2><ul>
<li><a href="http://blog.yuqiyu.com/spring-boot-2-x-articles.html" target="_blank" rel="noopener">SpringBoot2.x 教程汇总</a></li>
</ul>
<h2 id="疑惑配置提示？"><a href="#疑惑配置提示？" class="headerlink" title="疑惑配置提示？"></a>疑惑配置提示？</h2><p>当我们使用开发工具来配置时，就会出现相应的提示，这要完全要归功于<code>spring-configuration-metadata.json</code>配置元数据文件，该文件内记录了配置的<strong>名称</strong>、<strong>类型</strong>、<strong>归属类</strong>等信息，如果配置类型为<code>枚举</code>还可以实现<code>选择性配置</code>。</p>
<blockquote>
<p><code>SpringBoot</code>提供了一个依赖，它的主要任务就是自动生成配置元数据，该依赖的名称为<code>spring-boot-configuration-processor</code>，在打包时会在<code>META-INF</code>目录生成一个名为<code>spring-configuration-metadata.json</code>的文件。</p>
</blockquote>
<h2 id="配置方式"><a href="#配置方式" class="headerlink" title="配置方式"></a>配置方式</h2><p>虽然默认使用<code>properties</code>格式的配置文件，不过这种方式会导致配置的部分前缀冗余，可阅读性稍差，<code>SpringBoot</code>内部还支持使用<code>yaml</code>方式的配置文件，只需要在<code>src/main/resources</code>目录下创建一个名为<code>application.yml</code>文件即可，使用配置时同样也有提供功能。</p>
<p>项目内可以同时存在<code>application.properties</code>、<code>application.yml</code>两个文件，经过测试发现，<code>properties</code>优先级会高一些，相同名称的配置，会将<code>yml</code>内的配置覆盖掉。</p>
<h2 id="指定配置文件"><a href="#指定配置文件" class="headerlink" title="指定配置文件"></a>指定配置文件</h2><p>如果你的应用程序配置文件的名称不是<code>application</code>，你想要进行自定义，可以通过<code>--spring.config.name</code>命令行参数进行指定，如下所示：</p>
<figure class="highlight bash hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar project-sample.jar --spring.config.name=custome</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>注意事项：</strong>我们只需要指定配置文件的名称即可，可以使用<code>properties</code>或<code>yaml</code>文件格式，上面的配置会加载<code>src/main/resources/custome.yml</code>或<code>src/main/resources/custome.properties</code>。</p>
</blockquote>
<p>通过<code>--spring.config.name</code>仅仅是修改了配置文件的名称，那如果是修改配置文件所处的目录位置，我们需要怎么做呢？</p>
<p><code>SpringBoot</code>已经给我们准备好了，通过<code>--spring.config.location</code>参数就可以指定配置文件的位置，如下所示：</p>
<figure class="highlight bash hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar project-sample.jar --spring.config.location=classpath:/configs/custome.yml</span><br></pre></td></tr></table></figure>

<p>如果一个配置文件无法满足你的需求，那你看看下面这个方式：</p>
<figure class="highlight bash hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar project-sample.jar --spring.config.location=classpath:/configs/custome.yml,classpath:/configs/default.properties</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>注意事项：</strong>支持通过命令行参数的方式指定多个配置文件，使用英文半角 <code>,</code> 隔开即可。</p>
</blockquote>
<p>如果你通过<code>spring.config.location</code>指定的不是一个文件而是一个目录，在路径最后务必添加一个”/“结束，然后结合<code>spring.config.name</code>进行组合配置文件，组合示例如下：</p>
<figure class="highlight bash hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment"># 加载/configs/application.properties 或 /configs/application.yml（默认文件名）</span></span><br><span class="line">java -jar project-sample.jar --spring.config.location=classpath:/configs/</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment"># 加载/configs/custome.properties 或 /configs/custome.yml</span></span><br><span class="line">java -jar project-sample.jar --spring.config.location=classpath:/configs/ --spring.config.name=custome</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>注意事项：</strong><code>spring.config.name</code>该配置参数默认值为<code>application</code>，所以如果只是指定了<code>spring.config.location</code>并为目录形式，上面示例中会自动将<code>spring.config.name</code>追加到目录路径后，如果指定的<code>spring.config.location</code>并非是一个目录，这里会忽略<code>spring.config.name</code>的值。</p>
</blockquote>
<h2 id="加载顺序"><a href="#加载顺序" class="headerlink" title="加载顺序"></a>加载顺序</h2><p><code>SpringBoot</code>应用程序在启动时会遵循下面的顺序进行加载配置文件：</p>
<ol>
<li>类路径下的配置文件</li>
<li>类路径内config子目录的配置文件</li>
<li>当前项目根目录下的配置文件</li>
<li>当前项目根目录下config子目录的配置文件</li>
</ol>
<p>示例项目配置文件存放结构如下所示：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">. project-sample</span><br><span class="line">├── config</span><br><span class="line">│   ├── application.yml （4）</span><br><span class="line">│   └── src/main/resources</span><br><span class="line">|   │   ├── application.yml （1）</span><br><span class="line">|   │   └── config</span><br><span class="line">|   |   │   ├── application.yml （2）</span><br><span class="line">├── application.yml （3）</span><br></pre></td></tr></table></figure>

<p><strong>启动时加载配置文件顺序：1 &gt; 2 &gt; 3 &gt; 4</strong></p>
<blockquote>
<p><code>src/main/resources</code>下的配置文件在项目编译时，会放在<code>target/classes</code>下。</p>
</blockquote>
<h2 id="优先级覆盖"><a href="#优先级覆盖" class="headerlink" title="优先级覆盖"></a>优先级覆盖</h2><p><code>SpringBoot</code>配置文件存在一个特性，<strong>优先级较高的配置加载顺序比较靠后</strong>，<code>相同名称</code>的配置<code>优先级较高</code>的会<code>覆盖</code>掉<code>优先级较低</code>的内容。</p>
<p>为了更好地解释这一点，我们根据对应的加载顺序分别创建一个<code>application.yml</code>配置文件，来验证根据优先级的不同是否存在覆盖问题，如下图所示：</p>
<p><img src="http://blog.yuqiyu.com/images/post/spring-boot-basic-load-order-of-config-files-1.jpg" alt></p>
<p>在上面四个配置文件中都有一个名为<code>name</code>的配置，而红色字体标注的内容就是每个配置文件<code>name</code>的配置内容，下面我们来启动项目测试下输出内容。</p>
<h2 id="运行测试"><a href="#运行测试" class="headerlink" title="运行测试"></a>运行测试</h2><p>在测试之前我们让启动类实现<code>CommandLineRunner</code>接口，如下所示：</p>
<figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">@SpringBootApplication</span></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LoadOrderOfConfigFilesApplication</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">CommandLineRunner</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(LoadOrderOfConfigFilesApplication<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;name&#125;"</span>)</span><br><span class="line">    <span class="hljs-keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-meta">@Override</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">(String... args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        System.out.println(<span class="hljs-string">"配置名称："</span> + name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>项目启动后通过<code>run</code>方法进行打印<code>${name}</code>配置的内容。</p>
<h3 id="测试一：顺序覆盖"><a href="#测试一：顺序覆盖" class="headerlink" title="测试一：顺序覆盖"></a>测试一：顺序覆盖</h3><p>保留上面四个对应加载顺序的配置文件，启动项目，控制台输出内容：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">配置名称：project/config</span><br></pre></td></tr></table></figure>

<p>期望与实际输出是符合的，项目根下的<code>config</code>目录是<code>最后加载</code>的，所以它的<code>优先级</code>相对其他三个来说是<code>最高</code>的，<strong>覆盖顺序为：4 &gt; 3 &gt; 2 &gt; 1</strong>。</p>
<h3 id="测试二：跨顺序覆盖"><a href="#测试二：跨顺序覆盖" class="headerlink" title="测试二：跨顺序覆盖"></a>测试二：跨顺序覆盖</h3><p>上一个测试点我们对每一个加载顺序都对应添加了一个配置文件，那如果我们只有两个<code>project/config</code>、<code>classes/config</code>两个目录的配置文件，是否按照优先级进行覆盖呢？</p>
<p>删除另外两个，只保留<code>project/config</code>、<code>classes/config</code>两个位置的配置文件，启动项目控制台输出如下所示：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">配置名称：project/config</span><br></pre></td></tr></table></figure>

<p>同样是输出了优先级最高的<code>project/config</code>配置文件的内容，<strong>覆盖顺序为：4 &gt; 1</strong></p>
<h3 id="测试点：单顺序加载"><a href="#测试点：单顺序加载" class="headerlink" title="测试点：单顺序加载"></a>测试点：单顺序加载</h3><p>平时在项目开发中一般都是将<code>application.yml</code>配置文件放在<code>src/main/resources</code>目录下，然而根据上面的加载顺序来看，我们可以将配置文件放置在任意一处，启动时都会进行加载。</p>
<p>仅保留<code>classes/config</code>位置的配置文件，启动项目控制台输出内容如下所示：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">配置名称：classes/config</span><br></pre></td></tr></table></figure>

<p><code>IDEA</code>对<code>SpringBoot</code>的支持真的很强大， <code>classes/config</code>下的配置文件同样提供了<code>关键字提醒</code>功能。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>了解配置文件的加载顺序，才能得心应手的进行配置覆盖，完全控制在不同环境下使用不同的配置内容，要记住<code>classes/application.yml</code>优先级最低，<code>project/config/application.yml</code>优先级最高。</p>

        
        <!--原创-->
        
        <!--转载标注-->
        
        
      </div>
      <!--文章标签-->
      
      
      
    </div>
  </div>

  
  

  
  <!--评论-->
  
  
</div>

<script src="/js/readmore.js" type="text/javascript"></script>
<script>
  const btw = new BTWPlugin();
  btw.init({
    id: 'container',
    blogId: '10034-1569731208928-426',
    name: '恒宇少年',
    qrcode: 'https://blog.yuqiyu.com/images/mp.jpg',
    keyword: 'free',
  });
</script>

<!--<script src="/js/layui.js"></script>
<script>
  layui.use(['layer'], function () {
    var layer = layui.layer;
    var isShowOnce = localStorage.getItem('isShowHistory');
    if (!isShowOnce) {
      localStorage.setItem('isShowHistory',true);
      layer.open({
          type: 1
          ,title: false //不显示标题栏
          ,closeBtn: false
          ,area: '350px;'
          ,shade: 0.8
          ,id: 'LAY_layuipro' //设定一个id，防止重复弹出
          ,btn: ['带朕去看看', '给朕退下']
          ,btnAlign: 'c'
          ,moveType: 1 //拖拽模式，0或者1
          ,content: '<div style="padding: 50px; line-height: 22px; background-color: #393D49; color: #fff; font-size:13px; font-weight: 300;">你知道吗？阿里云的采购季来了！！！<br/><br/>云产品低至<b>0.75折</b> </br></br>ECS服务器最低 <b>¥74.43</b>/年 ...<br><br>MySQL云数据库最低 <b>¥188</b>/年 ...<br><br>1.5万条的短信只需要 <b>¥540</b> <br/><br/>500G的CDN流量包更是优惠到极致了...</div>'
          ,success: function(layero){
            var btn = layero.find('.layui-layer-btn');
            btn.find('.layui-layer-btn0').attr({
              href: 'https://www.aliyun.com/minisite/goods?userCode=rqxni4zt&share_source=copy_link'
              ,target: '_blank'
            });
          }
        });
    }
  });
</script>-->


<!--分页-->

    
<div class="card card-transparent">
    <nav class="pagination is-centered" role="navigation" aria-label="pagination">
        <div class="pagination-previous is-invisible is-hidden-mobile">
            <a class="is-flex-grow has-text-black-ter" href="/tags/SpringBoot/page/0/">上一页</a>
        </div>
        <div class="pagination-next">
            <a class="is-flex-grow has-text-black-ter" href="/tags/SpringBoot/page/2/">下一页</a>
        </div>
        <ul class="pagination-list is-hidden-mobile">
            
            <li><a class="pagination-link is-current" href="/tags/SpringBoot/">1</a></li>
            
            <li><a class="pagination-link has-text-black-ter" href="/tags/SpringBoot/page/2/">2</a></li>
            
            <li><span class="pagination-ellipsis has-text-black-ter">&hellip;</span></li>
            
            <li><a class="pagination-link has-text-black-ter" href="/tags/SpringBoot/page/6/">6</a></li>
            
        </ul>
    </nav>
</div>
</div>
                
                




<!--展示块 布局-->
<div class="column is-4-tablet is-3-desktop is-3-widescreen  has-order-3 column-right ">
    
        <div class="card widget">
  <div class="card-content" style="padding: 0%">
    <!--个人信息-->
    <img src="/images/profile2.png" />
    <!--第三方文章发布平台-->
    <div class="article-platform">
      <span><a href="https://www.jianshu.com/u/092df3f77bca" title="简书" target="_blank"><img src="/images/简书.png"
            width="25" /></a></span>
      <span><a href="https://me.csdn.net/weixin_42033269" title="CSDN" target="_blank"><img src="/images/csdn.svg"
            width="25" /></a></span>
      <span><a href="https://juejin.im/user/5a0aaeecf265da43163c96b7" title="掘金" target="_blank"><img
            src="/images/juejin-logo.svg" width="25" /></a></span>
      <span><a href="https://segmentfault.com/u/hengyushaonian/articles" title="思否" target="_blank"><img
            src="/images/思否.png" width="25" /></a></span>
      <span><a href="https://www.zhihu.com/people/heng-yu-shao-nian/posts" title="知乎" target="_blank"><img
            src="/images/知乎.svg" width="25" /></a></span>
      <span><a href="https://gitee.com/hengboy" title="源码托管平台：码云" target="_blank"><img src="/images/gitee.png"
            width="25" /></a></span>
      <span><a href="https://github.com/hengboy" title="源码托管平台：GitHub" target="_blank"><img src="/images/GitHub.svg"
            width="25" /></a></span>
    </div>
  </div>
</div>
    
        <!--热门文章列表，在文章详情显示，首页不显示-->

    
        


<div class="card widget">
  <div class="card-content" style="padding: 0">
    <a href="/apiboot-all-articles.html" target="_blank">
      <img src="/images/cover/ApiBoot推广封面.png" style="padding: 0px;height: 150px;width:100%" />
    </a>
  </div>
</div>


    
        


<div class="card widget" style="margin-top: 1rem;">

  <div class="card-content" style="padding: 0">

    <a href="http://gk.link/a/10f7u" target="_blank">
      <img src="/images/极客时间199礼包.png" style="padding: 0px;height: 130px;width:100%" />
    </a>

  </div>

</div>


    
        <!--学习专题列表-->


  <div class="card widget" id="topic">
  
  <div class="card-content" style="font-size: 14px;padding-top: 1rem;">
    <ul class="project">
      <li>
        <div class="project-left">
          <img src="/images/spring-boot.svg" width="55" />
        </div>
        <div class="project-right">
          <a href="/spring-boot-1-x-articles.html" target="_blank">
            <p class="title">SpringBoot v1.x 基础教程</p>

            <p class="desc">全网单篇文章阅读量超30万的SpringBoot免费基础教程</p>
          </a>
        </div>
      </li>
    </ul>
  </div>
  <hr>
  
  <div class="card-content" style="font-size: 14px;padding-top: 1rem;">
    <ul class="project">
      <li>
        <div class="project-left">
          <img src="/images/spring-boot.svg" width="55" />
        </div>
        <div class="project-right">
          <a href="/spring-boot-2-x-articles.html" target="_blank">
            <p class="title">SpringBoot v2.x 基础教程</p>

            <p class="desc">持续基于SpringBoot v2.3.x版本更新各个组件的使用以及源码分析</p>
          </a>
        </div>
      </li>
    </ul>
  </div>
  <hr>
  
  <div class="card-content" style="font-size: 14px;padding-top: 1rem;">
    <ul class="project">
      <li>
        <div class="project-left">
          <img src="/images/spring-cloud.svg" width="55" />
        </div>
        <div class="project-right">
          <a href="/spring-cloud-all-articles.html" target="_blank">
            <p class="title">SpringCloud 基础教程</p>

            <p class="desc">全面的涵盖SpringCloud各个组件的免费使用基础教程，持续更新SpringCloud Alibaba系列文章</p>
          </a>
        </div>
      </li>
    </ul>
  </div>
  <hr>
  
  <div class="card-content" style="font-size: 14px;padding-top: 1rem;">
    <ul class="project">
      <li>
        <div class="project-left">
          <img src="/images/api-boot.svg" width="55" />
        </div>
        <div class="project-right">
          <a href="/apiboot-all-articles.html" target="_blank">
            <p class="title">ApiBoot 基础教程</p>

            <p class="desc">新一代的接口服务落地解决方案，提供ApiBoot内的每一个组件的使用系列文章，助力你成为服务架构师.</p>
          </a>
        </div>
      </li>
    </ul>
  </div>
  <hr>
  
  <div class="card-content" style="font-size: 14px;padding-top: 1rem;">
    <ul class="project">
      <li>
        <div class="project-left">
          <img src="/images/技术杂谈.svg" width="55" />
        </div>
        <div class="project-right">
          <a href="/technical-talk.html" target="_blank">
            <p class="title">技术杂谈</p>

            <p class="desc">涵盖Java基础，数据结构与算法，Linux基础使用，代码规范，消息队列基础使用...</p>
          </a>
        </div>
      </li>
    </ul>
  </div>
  <hr>
  
</div>
<script src="/js/lay/modules/jquery.js"></script>
<script>
  var scrollTop = $("#topic").offset().top;
  $(window).scroll(function() {
    if ($(window).scrollTop() > scrollTop) {
      $("#topic").addClass("quoteSticky");
      $("#profile").show();
    } else {
      $("#topic").removeClass("quoteSticky");
      $("#profile").hide();
    }
  });
</script>


    
    
</div>

            </div>
        </div>
    </section>
    <footer class="footer">
  <div class="container">
    <div class="level">
      <div class="level-start has-text-centered-mobile">
        <p class="is-size-7">
          &copy; 2018 - 2022
          恒宇少年 - 于起宇&nbsp;鲁ICP备14029686号
          <br />
          希望每一篇文章都可以给你带来启发，都可以让你不再感到迷茫！
        </p>
      </div>
      <div class="level-end">
        
      </div>
    </div>
  </div>
</footer>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script>
<script>moment.locale("zh-CN");</script>

<script>
var IcarusThemeSettings = {
    article: {
        highlight: {
            clipboard: true,
            fold: 'unfolded'
        }
    }
};
</script>


    <script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script>



    
    
    
    <script src="/js/animation.js"></script>
    

    
    
    
    <script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script>
    <script src="/js/gallery.js" defer></script>
    

    
    

<div id="outdated">
    <h6>Your browser is out-of-date!</h6>
    <p>Update your browser to view this website correctly. <a id="btnUpdateBrowser" href="http://outdatedbrowser.com/">Update
            my browser now </a></p>
    <p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">&times;</a></p>
</div>
<script src="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.js" defer></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        outdatedBrowser({
            bgColor: '#f25648',
            color: '#ffffff',
            lowerThan: 'flex'
        });
    });
</script>


    
    
<script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.5/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    MathJax.Hub.Config({
        'HTML-CSS': {
            matchFontHeight: false
        },
        SVG: {
            matchFontHeight: false
        },
        CommonHTML: {
            matchFontHeight: false
        },
        tex2jax: {
            inlineMath: [
                ['$','$'],
                ['\\(','\\)']
            ]
        }
    });
});
</script>

    
    

<a id="back-to-top" title="回到顶端" href="javascript:;">
    <i class="fas fa-chevron-up"></i>
</a>
<script src="/js/back-to-top.js" defer></script>


    
    

    
    
    
    

    
    
    
    
    

    


<script src="/js/main.js" defer></script>

    
    <div class="searchbox ins-search">
    <div class="searchbox-container ins-search-container">
        <div class="searchbox-input-wrapper">
            <input type="text" class="searchbox-input ins-search-input" placeholder="想要查找什么..." />
            <span class="searchbox-close ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="searchbox-result-wrapper ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
    (function (window) {
        var INSIGHT_CONFIG = {
            TRANSLATION: {
                POSTS: '文章',
                PAGES: '页面',
                CATEGORIES: '分类',
                TAGS: '标签',
                UNTITLED: '(无标题)',
            },
            CONTENT_URL: '/content.json',
        };
        window.INSIGHT_CONFIG = INSIGHT_CONFIG;
    })(window);
</script>
<script src="/js/insight.js" defer></script>
<link rel="stylesheet" href="/css/search.css">
<link rel="stylesheet" href="/css/insight.css">
    
</body>
</html>